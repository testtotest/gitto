const util = require("../../utils/util");

const app = getApp();
// require("../../utils/util");
Page({
  /**
   * 页面的初始数据
   */
  data: {
    index:0,//picke
    applyed:false,
    characteristicArr:[],
    title: "拓展用户",
    userName: "",
    userPhone: "",
    address: "",
    productType: "",
    id:'',
    showBuyModel: false,
    list: [],
    subList: [],
    selectedImg:"",
    selectedName: "",
    selectedPrice: "",
    selectedArea: "",
    selectedPower:"",
    partsId:'',//选中的配件id
    active: 0,
    activeSub: 0
  },
  selectProduct: function (e) {
    this.setData({
      showBuyModel: true,
    });
    wx.hideTabBar({
      animation: false,
      success: (res) => {
        console.log("tabbar hide", res);
      },
    });
  },
  closedModel: function (e) {
    this.setData({
      showBuyModel: false,
    });
    wx.showTabBar({
      animation: false,
      success: (res) => {
        console.log("showTabBar", res);
      },
    });
  },
  handleSelected: function (e) {
    var that = this;
    console.log("click_______", e, e.currentTarget.dataset.id);
    let id = e.currentTarget.dataset.id;
    var arr=[]
    if(arr.length>1){
      arr.pop()
    }
    for (let i = 0; i < that.data.list.length; i++) {
      if (that.data.list[i].id == id) {
        console.log(that.data.list[i]);
        arr.push(that.data.list[i])
        that.setData({
          currentProduct:arr,
          active: i,
          selectedImg:app.globalData.imgUrl+that.data.list[i].photo1,
          selectedName: that.data.list[i].name,
          productType:that.data.list[i].id,
          subList: that.data.list[i].parts,
         // selectedPrice: that.data.list[i].parts[0].money,
         // selectedArea:that.data.list[i].parts[0].heatingArea,
          // selectedPrice: that.data.subList[0].money,
          // selectedArea: that.data.subList[0].heatingArea,
          // selectedPower:that.data.subList[0].power,
          // partsId:that.data.subList[0].id,
          activeSub: 0,
        });
        setTimeout(function(){
          that.setData({
            selectedPrice: that.data.subList[0].money,
            selectedArea: that.data.subList[0].heatingArea,
            selectedPower:that.data.subList[0].power,
            partsId:that.data.subList[0].id,
          })
        },50)
        break;
      }
    }
  },
  handleSubSelected: function (e) {
    var that = this;
    let index = e.currentTarget.dataset.id;
    console.log('tttt',e)
    for (let i = 0; i < that.data.subList.length; i++) {
      if (index == i) {
        that.setData({
          selectedPrice: that.data.subList[i].money,
          selectedArea: that.data.subList[i].heatingArea,
          selectedPower:that.data.subList[i].power,
          partsId:that.data.subList[i].id,
          activeSub: i,
        });
      }
    }
    console.log("click2_______", e, e.currentTarget.dataset.id);
  },
  goUrl:function(){
    wx.redirectTo({
      url: '../myinvited/myinvited'
    })
  },
  bindPickerChange: function (e) { //下拉选择
    var that = this;
    //console.log('picker发送选择改变，携带值为', e.detail.value)
    this.setData({
      index: e.detail.value,
      id:e.detail.value
    })
    for(var i=0;i<that.data.characteristicArr.length;i++){
      if(that.data.index ==i){

          let arr =[]
        arr.push(that.data.characteristicArr[i])
        that.setData({
          currentProduct:arr
        })
      }
    }
  },
  getUserName: function (e) {
    this.setData({
      userName: e.detail.value,
    });
  },
  getUserPhone: function (e) {
    this.setData({
      userPhone: e.detail.value,
    });
  },
  handleAddress: function (e) {
    this.setData({
      address: e.detail.value,
    });
  },
  getPhoneNumber: function (e) {
    // console.log(
    //   "mm",
    //   e.detail.encryptedData,
    //   e.detail.iv,
    //   that.data.session_key
    // );
    var that = this;
    if (e.detail.errMsg == "getPhoneNumber:ok") {
      // wx.request({
      //   url: "http://localhost/index/users/decodePhone",
      //   data: {
      //     encryptedData: e.detail.encryptedData,
      //     iv: e.detail.iv,
      //     sessionKey: that.data.session_key,
      //     uid: "",
      //   },
      //   method: "post",
      //   success: function (res) {
      //     console.log(res);
      //   },
      // });
    }
  },
  handleInvite: function () {
    var that = this;
    //提交
    if (!this.data.userName) {
      wx.showToast({
        title: "姓名不得为空",
        icon: "none",
        duration: 2000,
      });
      return false;
    }
    // if (util.chinese(this.data.userName)) {
    //   wx.showToast({
    //     title: "姓名必须为中文",
    //     icon: "none",
    //     duration: 2000,
    //   });
    //   return false;
    // }
    if (!this.data.userPhone) {
      wx.showToast({
        title: "手机号不得为空",
        icon: "none",
        duration: 2000,
      });
      return false;
    }
    if (this.data.userPhone.length != 11) {
      if (util.phone(this.data.userPhone)) {
        wx.showToast({
          title: "手机号位数部不正确",
          icon: "none",
          duration: 2000,
        });
      }
      return false;
    }
    if (util.phone(this.data.userPhone)) {
      wx.showToast({
        title: "手机号格式不正确",
        icon: "none",
        duration: 2000,
      });
      return false;
    }

    wx.request({
      url:
        app.globalData.baseUrl +
        "/ty/heatingApplet/equipment/requipmentApplication",
      method: "POST",
      data: {
        userId:app.globalData.userId,
        userName: that.data.userName,
        phone: that.data.userPhone,
        address: that.data.address,
        modelId: that.data.productType,
        type:2,
        id:that.data.id,
        partsId:that.data.partsId
      },
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      success: (res) => {
      //  console.log('res________________',res.data)
        if (res.data.status != "0000") {
          wx.showToast({
            title: res.data.message,
            icon: "none",
            duration: 2000,
          });
        }else{
          that.setData({
            applyed:true
          })
          // wx.showToast({
          //   title: res.data.message,
          //   icon: "none",
          //   duration: 2000,
          // });
        }

      },
    });
  },
  /**
   * 生命周期函数--监听页面加载
   */

  onLoad: function (options) {

    this.setData({
      applyed:false
    })
    // /equipment/requipmentApplication
    var that =this;
	
    var arr =[]
    wx.request({
      url:
        app.globalData.baseUrl +
        "/ty/heatingApplet/equipment/equipmentList",
      method: "POST",
      data: {},
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      success: (res) => {
      //  console.log('产品列表————+++++++++————',res.data.result,that.data.mId)
        if(that.data.mId){
          for(let i=0;i<res.data.result.length;i++){
          //  console.log('卧槽',that.data.mId,res.data.result[i].id.toString())
            if(that.data.mId==res.data.result[i].id.toString()){
              that.setData({
                index:i
              })
              arr.push(res.data.result[i])
              // that.setData({
              //   mId:arr[i].id
              // })
              that.setData({
                active:i,
                selectedName:res.data.result[i].name,
                selectedImg:app.globalData.imgUrl+res.data.result[i].photo1,
                //selectedImg:app.globalData.staticImg+res.data.result[0].photo3,
                selectedPrice:res.data.result[i].parts[0].money,
                productType:res.data.result[i].id,
                selectedArea: res.data.result[i].parts[0].heatingArea,
                selectedPower:res.data.result[i].parts[0].power,
                partsId:res.data.result[i].parts[0].id
              });
              break;
            }
          }
        }else{
                arr.push(res.data.result[0])
                that.setData({
                  mId: arr[0].id,
                  selectedName:res.data.result[0].name,
                  selectedImg:app.globalData.imgUrl+res.data.result[0].photo1,
                  //selectedImg:app.globalData.staticImg+res.data.result[0].photo3,
                  selectedPrice:res.data.result[0].parts[0].money,
                  selectedArea: res.data.result[0].parts[0].heatingArea,
                  selectedPower:res.data.result[0].parts[0].power,
                  partsId:res.data.result[0].parts[0].id,
                  productType:res.data.result[0].id,
                });
        }
       // console.log('_______2020',arr)


        that.setData({
          characteristicArr:res.data.result, //已无用
          currentProduct:arr,
          list:res.data.result,
          subList: res.data.result[0].parts,
         // mId:arr[0].id
        })
        if (res.data.status != "0000") {
          wx.showToast({
            title: res.data.message,
            icon: "none",
            duration: 2000,
          });
        }else{
          // wx.showToast({
          //   title: res.data.message,
          //   icon: "none",
          //   duration: 2000,
          // });
        }

      },
    });
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {},

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {},

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {},

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {},

 onShareAppMessage: function () {
 	  this.wxLogin()
 	  return {
 		title: '通云煤改电',
 	    path: '/pages/index/index?invCode='+wx.getStorageSync("invCodes"),
 		success: function (res) {
 		   wx.showToast({ 
 			icon: 'success',
 		     title: "转发成功",
 		     duration:2000
 		   })  
 		},
 		fail: function (res) {
 			wx.showToast({
 			  icon: 'success',
 			  title: res,
 			  duration:2000
 			})  
 		},
 	  }	
 },
 onShareTimeline: function (res) {
 	  this.wxLogin()
 	  return {
 		title: '通云煤改电',
 	    path: '/pages/index/index?invCode='+wx.getStorageSync("invCodes"),
 		success: function (res) {
 		    wx.showToast({
 		      title: "转发成功",
 		      duration:2000
 		    })  
 		},
 	  }	
 },
});
