//index.js
//获取应用实例
const app = getApp();
Page({
  data: {
    img: app.globalData.staticImg,
    serviceUrl: app.globalData.serviceUrl,
    broadcastData: [],
    productData: [],
    caseData:[],
	banData:[],
    userId: "",
    pageNo: 1,
    pageSize: 2 
  },
  wxLogin: function (invCode) {
    var that = this
    wx.login({
      success: (res) => {
        if (res.code) {
          wx.request({
            url: app.globalData.baseUrl + "/ty/heatingApplet/user/login",
            method: "POST",
            data: {
              code: res.code,
              invCode: invCode
            },
            success: (res) => {
              console.log(res)
              app.globalData.token = res.data.result.token;              
              app.globalData.userId = res.data.result.id;
              app.globalData.invCode = res.data.result.invCode;
              app.globalData.sessionKey = res.data.result.sessionKey;
              // that.getUserInfo()
              // if(res.data.result.invCode == invCode){//若自己打开自己分享的链接
              //   wx.setStorage({
              //     key: "invCoded",
              //     data: "",
              //   });
              //   app.globalData.invCoded =''
              // }
              wx.setStorage({
                key: "sessionKey",
                data: res.data.result.sessionKey,
              });
		  	  wx.setStorageSync("invCodes",res.data.result.invCode)			 
              wx.setStorage({
                key: "invCode",
                data: res.data.result.invCode,
              });
              wx.setStorage({
                key: "token",
                data: res.data.result.token,
              });
              wx.setStorage({
                key: "userId",
                data: res.data.result.id,
              });
              that.getBroadcast();
              that.getProductData();
              that.getCasesDate();
			  that.getBanData();
              // const code = res.statusCode.toString()
              // if(code.startsWith('2')){
              //   wx.setStorageSync('token', res.data.token)
              // }
            },
          });
        }
      },
    });
  },
  
  getShareInfo: function () {
    var that = this;
    wx.request({
      url: app.globalData.baseUrl + "/ty/heatingApplet/keyValue/getShareTitle",
      method: "post",
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      data: {
        // userId:app.globalData.userId,
        // pageNo:pageNo,
        // pageSize:pageSize
      },
      success: (res) => {
        //  console.log('res',res.data)
        if (res.data.status != '0000') {
          that.wxLogin()
        } else {
          app.globalData.shareTitle = res.data.result.title
          app.globalData.shareImgUrl = res.data.result.imgUrl
        }

      }
    })
  },


  //跳转产品详情页
  detailProduct: function (res) {
    // console.log("产品详情I__________", res.detail.id);
    wx.navigateTo({
      url: "../product/product?id=" + res.detail.id + '&tag=hot',
    });
  },
  //事件处理函数
  callPhone:function(e){
    wx.makePhoneCall({
      phoneNumber: e.currentTarget.dataset.id
    })
  },

  getProductData: function () {
    var that = this;
    wx.request({
      url: app.globalData.baseUrl + "/ty/heatingApplet/equipment/hotEquipment",
      method: "POST",
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      data: {},
      success: (res) => {
        //  console.log("getProductData", res, res.data.result);
        that.setData({
          productData: res.data.result,
        });
        wx.hideLoading({
          icon: "none"
        })
        wx.stopPullDownRefresh()
      },
    });
  },
  getBroadcast: function () {
    //
    var _that = this;
    wx.request({
      url: app.globalData.baseUrl + "/ty/heatingApplet/data/rewardList",
      method: "POST",
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      data: {},
      success: (res) => {
        //  console.log('getBroadcast',res,res.data.result)
        if (res.data.status != '0000') {
          // wx.showToast({    //token  校验不一致 重新调用wx.login()  接口授权
          //   icon:'none',
          //   title: res.data.message,
          //   duration:2000
          // })
          _that.wxLogin()
        }
        _that.setData({
          broadcastData: res.data.result,
        });
      },
    });
  },
  getCasesDate() {
    var that = this;
    wx.request({
        url: app.globalData.baseUrl + `/ty/heatingApplet/cases/query?pageNo=${this.data.pageNo}&pageSize=${this.data.pageSize}`,
        method: "get",
        header: {
            "content-type": "application/json", // 默认值
            "token": app.globalData.token
        },
        data: {},
        success: (res) => {
            that.setData({
                caseData: res.data.result.list,
                // totalCount: res.data.result.count
            });
            // if(!this.data.showNum){
            //     if(res.data.result.count <= this.data.pageSize){
            //         this.setData({
            //             nodata: true
            //         })
            //     }
            // }
            wx.hideLoading({
                icon: "none"
            })
        },
    });
},
getBanData: function () {
	var that = this;
	wx.request({
	  url: app.globalData.baseUrl + "/ty/heatingApplet/carousel/query",
	  method: "get",
	  header: {
	    "content-type": "application/json", // 默认值
	    token: app.globalData.token,
	  },	 
	  success: (res) => {
		  that.setData({
		    banData: res.data.result,
		  });	    	   
	  }
	})
},
  bindViewTap: function () {
    wx.navigateTo({
      url: "../logs/logs",
    });
  },

  aboutPage: function () {
    wx.navigateTo({
      url: "../about/about",
    });
  },

  handleContact(e) {
    console.log(e.detail.path)
    console.log(e.detail.query)
  },
  onMoreCaseTap() {
    wx.navigateTo({
      url: "../caselist/caselist"
    })
  },

  onMoreProTap(){
    wx.switchTab({
      url: '/pages/productlist/productlist',
    })
  },
  onShareAppMessage: function () {
	  this.wxLogin()
	  return {
		title: '通云煤改电',
	    path: '/pages/index/index?invCode='+wx.getStorageSync("invCodes"),
		success: function (res) {
		   wx.showToast({ 
			icon: 'success',
		     title: "转发成功",
		     duration:2000
		   })  
		},
		fail: function (res) {
			wx.showToast({
			  icon: 'success',
			  title: res,
			  duration:2000
			})  
		},
	  }	
  },
  onShareTimeline: function (res) {
	  this.wxLogin()
	  return {
		title: '通云煤改电',
	    path: '/pages/index/index?invCode='+wx.getStorageSync("invCodes"),
		success: function (res) {
		    wx.showToast({
		      title: "转发成功",
		      duration:2000
		    })  
		},
	  }	
  },
  onLoad: function (options) {
    wx.showLoading({
      title: '页面加载中...',
    })
    const that = this;
    this.getShareInfo();
    //-----------------
    // wx.showModal({
    //   title:'提交成功',
    //   content:'工作人员将在三个工作日内处理',
    //   showCancel:false,
    //   confirmText:'知道了',
    //   confirmColor:'#38CF91'
    // })
    //----------------
	console.log(options.invCode)
    if (options.invCode) { //如用户登录携带邀请码  （被邀请用户）
      //   console.log('被邀请码22222————————',options.invCode)
      wx.setStorage({
        key: "invCoded",
        data: options.invCode,
      });
    }

    wx.getStorage({
      key: "invCoded",
      success(res) {
        app.globalData.invCoded = res.data
      },
    });
    wx.getStorage({
      key: "token",
      success(res) {
         console.log('app_____token',res)
        if (res.data) {
          app.globalData.token = res.data
          //  console.log('app.globalData.token',app.globalData.token)
          that.getBroadcast();
          that.getProductData();
          that.getCasesDate();
		  that.getBanData();
        } else {
          that.wxLogin(options.invCode)
        }

        // console.log('app_____token222',res)
      },
      fail() {
        // that.wxLogin(options.invCode)
      }
    });
    wx.getStorage({
      key: "userId",
      success(res) {
        app.globalData.userId = res.data
        // that.getUserInfo()
      },
    });
    wx.getStorage({
      key: "invCode",
      success(res) {
        //  console.log('获取自己的邀请码')
        app.globalData.invCode = res.data
      },
    });

    //console.log('老铁7777')
    wx.getStorage({
      key: "userName",
      success(res) {
        that.setData({
          userName: res.data,
        });
      },
    });
    wx.getStorage({
      key: "userIcon",
      success(res) {
        that.setData({
          userIcon: res.data,
        });
      },
    });
    wx.getStorage({
      key: "sessionKey",
      success(res) {
        app.globalData.sessionKey = res.data
      },
    });

    wx.checkSession({
      success(res) {
        //  console.log('授权未过期__________',res)
        //session_key 未过期，并且在本生命周期一直有效
      },
      fail() {
        //  console.log('授权已过期__________')
        // session_key 已经失效，需要重新执行登录流程
        that.wxLogin(options.invCode)
      }
    })
  },
  
  onShow: function () {
    var that = this;
    wx.getStorage({
      key: "token",
      success(res) {
        // console.log('app_____',res)
        app.globalData.token = res.data
        //  that.getBroadcast();
        //  that.getProductData();
      },
    });
    wx.getStorage({
      key: "userId",
      success(res) {
        app.globalData.userId = res.data
        // that.getUserInfo()
      },
    });
  },
 
  onPullDownRefresh: function () {
    wx.showLoading({
      title: '页面重新加载中...',
    })
    this.getShareInfo();
    this.getBroadcast();
    this.getProductData();
    this.getCasesDate();
	this.getBanData();
  },
  

  
});