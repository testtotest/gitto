// pages/productdetail/productdetail.js
var app = getApp()
Page({

    /**
     * 页面的初始数据
     */
    data: {
        typeId: '',
        partsId: '',
        productDetail: {},
        defaultAddress: {},
        addresslist: [],
        cartCount: 0,
        price: '',
        heatingArea: '',
        showAddressModel: false,
        imgBaseUrl: app.globalData.imgUrl,
    },

    getProductDetail: function (typeId, entrance = '2') { //entrance 1:购物车 2:产品列表
        var _this = this
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/equipment/deviceInformation?typeId=${typeId}&entrance=${entrance}`,
            method: 'GET',
            header: {
                "content-type": "application/json", // 默认值
                token: app.globalData.token,
            },
            success: function (res) {
                if (res.data.status == "0000") {
                    _this.setData({
                        productDetail: res.data.result,
                    },function(){
                        _this.getPriceAndArea()
                    })
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },

    getDafaultAddress: function () {
        var _this = this
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/address/defaultAddress?userId=${app.globalData.userId}`,
            method: 'GET',
            header: {
                "content-type": "application/json", // 默认值
                token: app.globalData.token,
            },
            success: function (res) {
                if (res.data.status == "0000") {
                    _this.setData({
                        defaultAddress: res.data.result
                    })
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },

    getCart: function () {
        var _this = this
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/user/userinfo`,
            method: 'post',
            header: {
                "content-type": "application/json", // 默认值
                token: app.globalData.token,
            },
            data: {
                id: app.globalData.userId
            },
            success: function (res) {
                if (res.data.status == "0000") {
                    _this.setData({
                        cartCount: res.data.result.shopingNum
                    })
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },

    onJoinTap: function () {
        if (!this.data.typeId || !this.data.partsId) {
            wx.showToast({
                title: '请选择型号',
                icon: 'none',
            })
            return
        }
        var _this = this
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/shopping/addShoppingCart`,
            method: 'post',
            data: {
                userId: app.globalData.userId,
                typeId: this.data.typeId,
                partsId: this.data.partsId
            },
            header: {
                "content-type": "application/json", // 默认值
                token: app.globalData.token,
            },
            success: function (res) {
                if (res.data.status == "0000") {
                    _this.getCart()
                    wx.showToast({
                        title: '加入购物车成功',
                        icon: 'none'
                    })
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },

    goProductDet: function () {
        wx.navigateTo({
            url: "../product/product?id=" + this.data.typeId + '&tag=common',
        })
    },

    onPowerTap: function (e) {
        var stockStatus = e.currentTarget.dataset.stock
        var partsId = e.currentTarget.dataset.partsid
        var level = e.currentTarget.dataset.level
        var typeId = this.data.typeId
        if (!stockStatus) {
            wx.showToast({
                title: '无库存',
                icon: 'none'
            })
            return
        }
        this.setData({
            price: e.currentTarget.dataset.price,
            heatingArea: e.currentTarget.dataset.heatingarea,
            partsId: partsId
        })
        this.setProductDetail(typeId, partsId, level)
    },

    setProductDetail: function (typeId, partsId, level) {
        var productDetail = this.data.productDetail
        for (var idx in productDetail) {
            productDetail[idx].check = false
            if (productDetail[idx].typeId == typeId) {
                productDetail[idx].check = true
            }
            if (partsId) {
                var seconddata = productDetail[idx].parts.parts
                for (var idx_part in seconddata) {
                    if (level == 'second') {
                        if (seconddata[idx_part].partsId == partsId) {
                            seconddata[idx_part].check = true
                        } else {
                            seconddata[idx_part].check = false
                        }
                    }
                    var thirddata = seconddata[idx_part].parts ? seconddata[idx_part].parts.parts : null
                    if (thirddata && level == 'third') {
                        console.log(thirddata)
                        for (var idx_part_z in thirddata) {
                            if (thirddata[idx_part_z].partsId == partsId) {
                                thirddata[idx_part_z].check = true
                            } else {
                                thirddata[idx_part_z].check = false
                            }
                        }
                    }
                }
            }
        }
        this.setData({
            productDetail: productDetail,
            typeId: typeId,
            partsId: partsId
        })
        this.getPriceAndArea()
    },

    getPriceAndArea() {
        var productDetail = this.data.productDetail
        for (var idx in productDetail) {
            var seconddata = productDetail[idx].parts.parts
            for (var idx_part in seconddata) {

                if (seconddata[idx_part].check) {
                    this.setData({
                        partsId: seconddata[idx_part].partsId,
                        price:  seconddata[idx_part].money / 100,
                        heatingArea: seconddata[idx_part].heatingArea,
                    })
                }

                var thirddata = seconddata[idx_part].parts ? seconddata[idx_part].parts.parts : null
                for (var idx_part_z in thirddata) {
                    if (thirddata[idx_part_z].check) {
                        this.setData({
                            partsId: thirddata[idx_part_z].partsId,
                            price:  thirddata[idx_part_z].money,
                            heatingArea: thirddata[idx_part_z].heatingArea,
                        })
                    }

                }
            }
        }

    },

    onCartTap: function () {
        wx.switchTab({
            url: '/pages/cart/cart',
        })
    },

    onAddressTap: function () {
        this.setData({
            showAddressModel: true
        })
    },

    closedModel: function () {
        this.setData({
            showAddressModel: false
        })
    },

    getAddressList: function () {
        var _this = this
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/address/myAddressList?pageNo=1&pageSize=30&userId=${app.globalData.userId}`,
            method: "get",
            header: {
                "content-type": "application/json", // 默认值
                "token": app.globalData.token
            },
            data: {},
            success: function (res) {
                wx.hideLoading();
                if (res.data.status === "0000") {
                    if (res.data.result.list.length == 0) {
                        _this.setData({
                            nodata: true
                        })
                    } else {
                        _this.setData({
                            nodata: false,
                            addresslist: res.data.result.list
                        })
                    }

                } else {
                    _this.setData({
                        nodata: true
                    })
                }
            }
        })
    },

    detailAddress: function (e) {
        this.setData({
            defaultAddress: e.detail.address,
            showAddressModel: false
        })
    },

    onPayTap: function () {
        if (!this.data.defaultAddress) {
            wx.showToast({
                title: '请选择地址',
                icon: 'none',
            })
            return
        }
        if (!this.data.typeId || !this.data.partsId) {
            wx.showToast({
                title: '请选择型号',
                icon: 'none',
            })
            return
        }
        var _this = this
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/order/createPayInfo`,
            method: 'post',
            header: {
                "content-type": "application/json", // 默认值
                token: app.globalData.token,
            },
            data: {
                userId: app.globalData.userId,
                orderType: '1',
                partsIdArr: Array.of(_this.data.partsId),
                addressId: _this.data.defaultAddress.id,
            },
            success: function (res) {
                if (res.data.status == "0000") {
                    var payargs = res.data.result
                    wx.requestPayment({
                        timeStamp: payargs.timeStamp,
                        nonceStr: payargs.nonceStr,
                        package: payargs.package,
                        signType: payargs.signType,
                        paySign: payargs.paySign,
                        success(res) {
                            wx.navigateTo({
                                url: '/pages/order/order?orderId=' + payargs.orderId,
                            })
                        }
                    })
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },

    addAddress() {
        wx.navigateTo({
            url: '/pages/addressedit/addressedit?type=add',
        })
    },

    /**
     * 生命周期函数--监听页面加载
     */
    onLoad: function (options) {
        var typeId = options.id
        this.setData({
            typeId: typeId
        })
        this.getProductDetail(typeId)
    },

    /**
     * 生命周期函数--监听页面初次渲染完成
     */
    onReady: function () {

    },

    /**
     * 生命周期函数--监听页面显示
     */
    onShow: function () {
        this.getDafaultAddress()
        this.getCart()
        this.getAddressList()
    },

    /**
     * 生命周期函数--监听页面隐藏
     */
    onHide: function () {

    },

    /**
     * 生命周期函数--监听页面卸载
     */
    onUnload: function () {

    },

    /**
     * 页面相关事件处理函数--监听用户下拉动作
     */
    onPullDownRefresh: function () {

    },

    /**
     * 页面上拉触底事件的处理函数
     */
    onReachBottom: function () {

    },

    /**
     * 用户点击右上角分享
     */
    onShareAppMessage: function () {

    }
})