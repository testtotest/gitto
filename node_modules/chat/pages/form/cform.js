// pages/form/cform.js
Page({
 
  /**
   * 页面的初始数据
   */
  data: {
   
    placeholder: '请选择',
    array: ['发电机', '充电器', '引擎动力', '其他'],
    objectArray: [
      {
        id: 0,
        name: '发电机'
      },
      {
        id: 1,
        name: '充电器'
      },
      {
        id: 2,
        name: '引擎动力'
      },
      {
        id: 3,
        name: '其他'
      }
    ],
 
    multiIndex: [0, 0, 0],
    date: '2016-09-01',
    time: '12:01',
    region: ['广东省', '广州市', '海珠区'],
    customItem: '全部',
	nodata: true,
	addresslist: [],
	showAddressModel: false,
	province: [],
	city: [],
	county: [],
	addressView: [],
	imgs:[], // 安装位置图片集合
	imgc:'', //企业主体照片
	imgz:[], //证明照片集合
	imgf:[], //法人身份证件照集合
	imgd:'', //企业主体照片
	token:'MTkwLTE2MDEzNDY5ODA0MTgtMWY3ODA4ZjUwYmQ5NGVhZWEzYTIzNGE2MjQ0MDMwY2I=',
  },
  
  // 上传图片
  chooseImg: function (e) {	
		this.up("s");	
  },
  choosecImg: function (e) {
  		this.up("c");	
  },
  choosezImg: function (e) {
  		this.up("z");	
  },
  choosefImg: function (e) {
  		this.up("f");	
  },
  choosedImg: function (e) {
  		this.up("d");	
  },
  up:function(t)
  {
	 
	  var that = this;
	  var imgs = this.data.imgs;
	  if (imgs.length >= 9) {
	    this.setData({
	  	lenMore: 1
	    });
	    setTimeout(function () {
	  	that.setData({
	  	  lenMore: 0
	  	});
	    }, 2500);
	    return false;
	   }
	   wx.chooseImage({
	   // count: 1, // 默认9
	   sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
	   sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
	   success: function (res) {
	 	// 返回选定照片的本地文件路径列表，tempFilePath可以作为img标签的src属性显示图片
	 		var tempFilePaths = res.tempFilePaths;
	 		var imgs = that.data.imgs;
			var imgc = that.data.imgc;
			var imgz = that.data.imgz;
			var imgf = that.data.imgf;
			var imgd = that.data.imgd;
	 	// console.log(tempFilePaths + '----');
	 		
	 		
		    if(t=="s")
			{
				for (var i = 0; i < tempFilePaths.length; i++) {
				  if (imgs.length >= 9) {
					// that.setData({
					//   imgs: imgs
					// });
					return false;
				  } else {
					 that.toBase(tempFilePaths[i]);										 
				  }
				}
				
				
				
			}
			else if(t=="c"){
				
				that.setData({
				  imgc: tempFilePaths[0]
				});				
			}
			else if(t=="d"){
				
				that.setData({
				  imgd: tempFilePaths[0]
				});				
			}
			else if(t=="z"){
				for (var i = 0; i < tempFilePaths.length; i++) {
				  if (imgz.length >= 9) {
					that.setData({
					  imgz: imgz
					});
					return false;
				  } else {
					var imgstr={"photo":tempFilePaths[i]}  
					imgz.push(imgstr);
				  }
				} 
				that.setData({
				  imgz: imgz
				});
			}
			else if(t=="f"){
			   for (var i = 0; i < tempFilePaths.length; i++) {
			     if (imgf.length >= 9) {
			   	that.setData({
			   	  imgf: imgs
			   	});
			   	return false;
			     } else {
			   	var imgstr={"photo":tempFilePaths[i]}  
			   	imgf.push(imgstr);
			     }
			   } 
			   that.setData({
			     imgf: imgf
			   });
			}
	 		
	   }
	 });
  },
  toBase: function (e) {
	 var that = this;	
	 var imgs = that.data.imgs;
	 wx.uploadFile({ 
		 url: "https://testxny.tongyunzn.com/ty/heatingApplet/file/upload",
		 filePath: e,//图片在手机里的存储路径
		 name: 'file', 
		 header: {				
				 "token": this.data.token
		 },			  
		 success(res) {
			 // obj.prescriptionPath = data.data.originalUrl; 
			  const data = JSON.parse(res.data);
			  if(data.status == 0){
				 var imgstr={"photo":data.result}
				 imgs.push(imgstr);
			  } 
			  that.setData({
			    imgs: imgs
			  });
			 
		      // 
		      //   that.setData({
		      //     chooseImageUrl: data.data.originalUrl,
		      //     obj:obj
		      //   })
		      // 
		 }
	 })
	 
	   //  wx.getFileSystemManager().readFile({
	   //      filePath: e, // 选择图片返回的相对路径
	   //      encoding: 'base64', // 编码格式
	   //      success: res => { // 成功的回调 multipart/form-data
    //             var str='data:image/png;base64,' + res.data;
				// wx.request({
				//      url:  "https://testxny.tongyunzn.com/ty/heatingApplet/file/upload",
				// 	 method: "post",
				//      data: {
				// 		  "file": str
				//      },
					 
				// 	 header: {
				// 		 "content-type": 'application/x-www-form-urlencoded',
				// 		 "token": this.data.token
				// 	 },			  
				//      success(re){						
				// 		console.log(re)
				//      }
				// })
	   //      }
	   //  })
	 
	  
	 

  },
  // 删除图片
  deleteImg: function (e) {
    var imgs = this.data.imgs;
    var index = e.currentTarget.dataset.index;
    imgs.splice(index, 1);
    this.setData({
      imgs: imgs
    });
  },
  // 预览图片
  previewImg: function (e) {
    //获取当前图片的下标
    var index = e.currentTarget.dataset.index;
    //所有图片
    var imgs = this.data.imgs;
    wx.previewImage({
      //当前显示图片
      current: imgs[index],
      //所有图片
      urls: imgs
    })
  },
 
 
 
  bindPickerChange(e) {
    console.log('picker发送选择改变，携带值为', e.detail.value)
    this.setData({
      index: e.detail.value
    })
  },
  clearFont() {
    this.setData({
      placeholder: ''
    })
  },
 
  bindRegionChange(e) {
    console.log('picker发送选择改变，携带值为', e.detail.value)
    this.setData({
      region: e.detail.value
    })
  },
 changeDate:function(e){
     //获取当前选择日期
     var date = e.detail.value;
     this.setData({
       currentDate:date
     })
   },
    addForm:function(e){
		//1000068
		
		var that = this;
		wx.request({
		    url:  "https://testxny.tongyunzn.com/ty/heatingApplet/newclothes/addNewClothes",
		    method: "post",
		    header: {
		        "content-type": "application/json", // 默认值
		        "token":that.data.token
		    },
		    data: {
		        type: "2",
		        region: "1000068",
		        address: "地址测试",
				powerConsumptionTime: that.data.currentDate,
				equityProveType: "1",
				documentType: "1",
				ownerName: "法人姓名",				
				ownerIdCard: "123456789",
				applicantPhone: "18249002993",
				transformer: "2",
				capacity: "30",
				typeProof: "1",				
				enterpriseName: "企业名称",
				installLocationList: that.data.imgs,//List
				companyPhoto: that.data.imgc,
				equityProveList: that.data.imgs, //List
				authorizationPhoto: that.data.imgd,
				identityProveList: that.data.imgs, //List
		    },			
		    success(res){
		        if (res.data.status == "0000") {
		           wx.showToast({
		               title: res.data.message,
		               icon: "none",
		               duration: 2000,
		             });
		        }else{
		            wx.showToast({
		                title: res.data.message,
		                icon: "none",
		                duration: 2000,
		              });
		        }
		       
		    }
		})
    },
	onLoad: function (options) {
	  
		
	},
	onRegionTap: function (e) {
	    wx.showLoading({
	        title: "加载中...",
	    })
	    var _this = this
	    var parentId = e.currentTarget.dataset.id || ''
	    var name = e.currentTarget.dataset.name || ''
	    var url = parentId ? `/ty/heatingApplet/address/addressList?parentId=${parentId}` : `/ty/heatingApplet/address/addressList`;
		
	    this.setAreaTap(name);
	    wx.request({
	        url: "https://testxny.tongyunzn.com" + url,
	        method: "get",
	        header: {
	            "content-type": "application/x-www-form-urlencoded", // 默认值
	            "token":"MTkwLTE2MDEwOTYzMjkyNzktMGNiMDZmMWQ4OGRjNGM3YTg1ZDlhYjBmOTY4NGM0NzA="},
	        success: function (res) {
			 
	            if (res.data.status == "0000") {
	                _this.setData({
	                    addressView: res.data.result,
	                    showAddressModel: true,
	                })
	
	                if (res.data.result.length == 0) {
	                    var area = ''
	                    for(var i=0; i < _this.data.areaArray.length-1; i++){
	                        area += _this.data.areaArray[i]
	                    }
	                    _this.setData({
	                        showAddressModel: false,
	                        regionId: parentId,
	                        area: area
	                    })
	                    wx.removeStorageSync('areaArray')
	                }
	            }
	        },
	        complete: function () {
	            wx.hideLoading()
	        }
	    })
	},
	setAreaTap: function (name) {
	    var select = "请选择"
	    var areaArray = wx.getStorageSync('areaArray') || []
	    areaArray.pop()
	    name !== '' && areaArray.push(name)
	    areaArray.push(select)
	    wx.setStorageSync('areaArray', areaArray)
	    this.setData({
	        areaArray: areaArray
	    })
	},
	closedModel: function (e) {
	    this.setData({
	        showAddressModel: false,
	    });
	    wx.showTabBar({
	        animation: false,
	        success: (res) => {
	            console.log("showTabBar", res);
	        },
	    });
	    wx.removeStorageSync('areaArray')
	},
	
	
	
})