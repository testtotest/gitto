var app = getApp()
var util = require('../../utils/util')
Page({

  /**
   * 页面的初始数据
   */
  data: {
    showModal: false, //取消框
	showd: false, //是否是住宅用电
	isshowd:'请选择',
	itemsshowd:  [{
	      message: '身份证',
	    },{
	      message: '军人证',
	    },{
	      message: '护照',
	    },{
	      message: '户口薄',
	    },{
	      message: '台胞证及港澳身份证件',
	    },{
	      message: '公安机关户籍证明',
	    }],
	isbg:false,	
	showc: false, //企业主体证明类型
	isshowc:'请选择',	
	itemsc: [{
	        message: '产权证',
	      },{
	        message: '国有土地使用证'
	      },{
	        message: '集体土地使用证'
	      },{
	        message: '购房合同'
	      },{
	        message: '法律文书'
	      },{
	        message: '产权合法证明'
	      },{
	        message: '其他(产权证、租赁协议)'
	      }],
	 imgz:[],
	 imgzz:[],
	 imgs:[],
	 imgzsz:[],
	 imgzszbase:[],
	 showpicaModal: true,
	 showpicbModal: false,
	 iaa:"https://img.tongyunzn.com/tyxcxtp/sfz.png",
	 ibb:"https://img.tongyunzn.com/tyxcxtp/sff.png",
	 token:'MTkwLTE2MDEzNDY5ODA0MTgtMWY3ODA4ZjUwYmQ5NGVhZWEzYTIzNGE2MjQ0MDMwY2I=',
  },

  formModal:function (){
	 var that = this;

	if(this.data.isshowc=="请选择")
	{
				wx.showToast({
					title: "请选择产权证明类型",
					icon: "none",
					duration: 2000,
				});
				return false;	  
	}
	 var imgzsz = this.data.imgzsz;
	console.log("imgzsz"+imgzsz.length)
	if (imgzsz.length <=0) {
				wx.showToast({
					title: "请上传产权证明照片",
					icon: "none",
					duration: 2000,
				});
				return false;		
	}
	if(this.data.isshowd=="请选择")
	{
				wx.showToast({
					title: "请选择身份证件类型",
					icon: "none",
					duration: 2000,
				});
				return false;	  
	}
	var imgz = this.data.imgz;
	if (imgz.length < 1) {
				wx.showToast({
					title: "请上传身份证明照片",
					icon: "none",
					duration: 2000,
				});
				return false;		
	}
	
	 if (!this.data.ownerName) {
	     wx.showToast({
	         title: "姓名不得为空",
	         icon: "none",
	         duration: 2000,
	     });
	     return false;
	 }
	 if (!this.data.applicantPhone) {
	     wx.showToast({
	         title: "手机号不得为空",
	         icon: "none",
	         duration: 2000,
	     });
	     return false;
	 }
	 if (this.data.applicantPhone.length != 11) {
	     if (util.phone(this.data.applicantPhone)) {
	         wx.showToast({
	             title: "手机号位数不正确",
	             icon: "none",
	             duration: 2000,
	         });
	     }
	     return false;
	 }
	 if (util.phone(this.data.applicantPhone)) {
	     wx.showToast({
	         title: "手机号格式不正确",
	         icon: "none",
	         duration: 2000,
	     });
	     return false;
	 }
	
		 
	 wx.request({
	     url:  app.globalData.baseUrl+"/ty/heatingApplet/newclothes/addNewClothes",		
	     method: "post",
	     header: {
	         "content-type": "application/json", // 默认值
	         "token":app.globalData.token
	     },
	     data: {
	         type: "1",
	         region: wx.getStorageSync("region"),
	         address: wx.getStorageSync("address"),
	 		powerConsumptionTime: wx.getStorageSync("powerConsumptionTime"),
	 		equityProveType:that.data.isshowd,   //that.data.isshowd 产权证明类型
	 		documentType: that.data.isshowc,     //that.data.isshowc 法人证件类型
	 		ownerName: that.data.ownerName,				
	 		ownerIdCard: that.data.ownerIdCard,
	 		applicantPhone: that.data.applicantPhone,
	 		transformer: wx.getStorageSync("transformer"),
	 		capacity: wx.getStorageSync("capacity"),
	 		 typeProof: "0",	 //企业主体证明类型			
	 		enterpriseName: '0', //企业名称
	 		 installLocationList: wx.getStorageSync("installLocationList"),//List安装位置图片集合
	 		 companyPhoto: '',   //企业主体照片
	 		 equityProveList:that.data.imgzsz, //产权证明照片List
	 		 authorizationPhoto: '',   //非
	 		 identityProveList: that.data.imgz, //List法人身份证件照
	     },			
	     success(res){
	         if (res.data.status == "0000") {
	 					wx.setStorageSync("region",null)
	 					wx.setStorageSync("address",null)
	 					wx.setStorageSync("transformer",null)
	 					wx.setStorageSync("capacity",null)
	 					wx.setStorageSync("powerConsumptionTime",null)					
	 					wx.setStorageSync("typeProof",null) 
	 					wx.setStorageSync("enterpriseName",null)	
	 					wx.setStorageSync("companyPhoto",null)
	 					wx.setStorageSync("equityProveType",null)
	 					wx.setStorageSync("equityProveList",null)
						wx.showToast({
						    title: res.data.message,
						    icon: "none",
						    duration: 2000,
						  });
						  setTimeout(
						    function () {
						   wx.switchTab({url:"../account/account"})
						     }, 
						    2000) 
						   
	            
	         }else{
	             wx.showToast({
	                 title: res.data.message,
	                 icon: "none",
	                 duration: 2000,
	               });
	         }
	        
	     }
	 })
  },
  chooseiaImg: function (e) {
	        var imgs = this.data.imgs;
	        if (imgs.length >= 2) {
				wx.showToast({
					title: "上传2张照片",
					icon: "none",
					duration: 2000,
				});
				return false;
			}
    		this.up("ia");
  },
  chooseibImg: function (e) {
	  var imgs = this.data.imgs;
	  if (imgs.length >= 2) {
	  	wx.showToast({
	  		title: "上传2张照片",
	  		icon: "none",
	  		duration: 2000,
	  	});
	  	return false;
	  }
    		this.up("ib");	
  },
  choosezImg: function (e) {
	      if(this.data.isshowd=="请选择")
	      {
	      			wx.showToast({
	      				title: "请选择类型",
	      				icon: "none",
	      				duration: 2000,
	      			});
	      			return false;	  
	      }
		  var imgz = this.data.imgz;
		  if (imgz.length >= 6) {
			wx.showToast({
				title: "最多可上传6张照片",
				icon: "none",
				duration: 2000,
			});
			return false;		
		  }
    	  this.up("z");	
  },
  //产权证明照片
  choosezsImg: function (e) {
	  if(this.data.isshowc=="请选择")
	  {
	  			wx.showToast({
	  				title: "请选择类型",
	  				icon: "none",
	  				duration: 2000,
	  			});
	  			return false;	  
	  }
	  var imgzsz = this.data.imgzsz;
	  if (imgzsz.length >= 6) {
	  			wx.showToast({
	  				title: "最多可上传6张照片",
	  				icon: "none",
	  				duration: 2000,
	  			});
	  			return false;		
	  }
	  this.up("zs");	
  },
  up:function(t)
  {
  	var that = this;
  	
  	wx.chooseImage({
  	  // count: 1, // 默认9
  	  sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
  	  sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
  	  success: function (res) {
  		// 返回选定照片的本地文件路径列表，tempFilePath可以作为img标签的src属性显示图片
  			var tempFilePaths = res.tempFilePaths;
  			    var imgz = that.data.imgz;
  				var imgzz = that.data.imgzz;				
				 var imgs = that.data.imgs;	
					 
					 var imgzsz = that.data.imgzsz; //产权证明照片
					 var imgzszbase = that.data.imgzszbase;
  		// console.log(tempFilePaths + '----');
  			    if(t=="c")
  				{
  					that.setData({
  					  imgc: tempFilePaths[0]
  					});		
  				}
  				else if(t=="z"){
  					var imgstr={"photo":tempFilePaths[0]}
  					imgzz.push(imgstr);
  					that.setData({
  					   imgzz: imgzz
  					});
  					that.toBase(tempFilePaths[0],"z")		
  				}
				else if(t=="zs"){
					var imgstr={"photo":tempFilePaths[0]}
					imgzszbase.push(imgstr);
					that.setData({
					   imgzszbase: imgzszbase
					});
					that.toBase(tempFilePaths[0],"zs")
				}
				else if(t=="ia"){			
					that.setData({
					  iaa: tempFilePaths[0]
					});
					that.toBase(tempFilePaths[0],"ia")	
				}
				else if(t=="ib"){
					that.setData({
					  ibb: tempFilePaths[0]
					});				
					that.toBase(tempFilePaths[0],"ib")			
				}
				
  	  }
  	});
  },
  deleteImg: function (e) {
	  console.log("test")
  	var that = this;
  	var imgz = that.data.imgz;
      var imgzz = that.data.imgzz;
      var index = e.currentTarget.dataset.index;
  	  imgz.splice(index, 1);
      imgzz.splice(index, 1);
      that.setData({
  	    imgz: imgz,	
        imgzz: imgzz
      });
  },
  deleteImgs: function (e) {	 
  	var that = this;
  	var imgzsz = that.data.imgzsz;
      var imgzszbase = that.data.imgzszbase;
      var index = e.currentTarget.dataset.index;	 
      imgzsz.splice(index, 1);
      imgzszbase.splice(index, 1);
      that.setData({
  	  imgzsz: imgzsz,	
      imgzszbase: imgzszbase
      });
  },
  toBase: function (e,t) {
  	var that = this;  
  	var imgz = that.data.imgz; //证明照片集合
	var imgs = that.data.imgs; //证明照片集合
	var imgzsz = that.data.imgzsz; //产权证明照片
  	wx.uploadFile({
  			 url: app.globalData.baseUrl+"/ty/heatingApplet/file/upload",
  			 filePath: e,//图片在手机里的存储路径
  			 name: 'file', 
  			 header: {				
  					 "token": app.globalData.token
  			 },			  
  			 success(res) {
  				const data = JSON.parse(res.data);
  				if(data.status == 0){
  					if(t=="ia")
  					{
						
						var imgstr={"photo":data.result}
						imgz[0]=imgstr;					
  						that.setData({
  						  ia: data.result
  						});
					} else if(t=="ib"){
						var imgstr={"photo":data.result}
						imgz[1]=imgstr;						
						that.setData({
						  ib: data.result
						});
  					} else if(t=="z"){
  						var imgstr={"photo":data.result}
  						imgz.push(imgstr);
  						that.setData({
  						   imgz: imgz
  						});
					} else if(t=="zs"){
						var imgstr={"photo":data.result}
						imgzsz.push(imgstr);
						that.setData({
						   imgzsz: imgzsz
						});
  					} 
					
  				}				
  			 }
  	})
  	
  }, 
  onBtna:function (){
  	this.setData({showd:true,isbg:true})
  },
  selBtnb:function (res){
	  
	   if(this.data.itemsshowd[res.currentTarget.id].message=="身份证")
	   {
		   this.setData({showpicaModal:false,showpicbModal:true})
	   }
	   else
	   {
		   this.setData({showpicaModal:true,showpicbModal:false})
	   }
	  
  	   this.setData({isshowd:this.data.itemsshowd[res.currentTarget.id].message})
  	   this.setData({showd:false,isbg:false})
	   var that = this;
	   		var imgz = that.data.imgz;
			var imgzz = that.data.imgzz;	
	   		for (var i = 0; i < imgz.length; i++) {
	   			imgz.splice(i);
				imgzz.splice(i);
	   		}
			that.setData({
			   imgzz: imgzz
			});
			   
  },
  cloBtnb:function (){
  	  this.setData({showd:false,isbg:false})
  },
  
  onBtnc:function (){
  	  this.setData({showc:true,isbg:true})
  },
  selBtnc:function (res){
	 
  	  this.setData({isshowc:this.data.itemsc[res.currentTarget.id].message})
  	  this.setData({showc:false,isbg:false})
			  
  },
  cloBtnc:function (){
  	this.setData({showc:false,isbg:false})
  },
//取消框
oshowModal:function (){
	this.setData({showModal:true})
},
cshowModal:function (){
	this.setData({showModal:false})	
},
coshowModal:function (){
	wx.switchTab({url:"../account/account"})
},

  onLoad: function (options) {
     // console.log(wx.getStorageSync("region"))
     // console.log(wx.getStorageSync("address"))
     // console.log(wx.getStorageSync("transformer"))
     // console.log(wx.getStorageSync("capacity"))
     // console.log(wx.getStorageSync("installLocationList"))
     // console.log(wx.getStorageSync("powerConsumptionTime"))
	
  },


  onReady: function () {

  },

 
  onShow: function () {

  },

})