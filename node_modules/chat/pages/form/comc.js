var app = getApp()
var util = require('../../utils/util')
Page({

  /**
   * 页面的初始数据
   */
  data: {
    showModal: false, //取消框
	showd: false, //是否是住宅用电
	isshowd:'请选择',
	itemsshowd:  [{
	      message: '身份证',
	    },{
	      message: '军人证',
	    },{
	      message: '护照',
	    },{
	      message: '户口薄',
	    },{
	      message: '台胞证及港澳身份证件',
	    },{
	      message: '公安机关户籍证明',
	    }],
	  isbg:false,	
	  imgz:[],
	  imgzz:[],
	  token:'MTkwLTE2MDEzNDY5ODA0MTgtMWY3ODA4ZjUwYmQ5NGVhZWEzYTIzNGE2MjQ0MDMwY2I=',
	  showpicaModal: true,
	  showpicbModal: false,
	 iaa:"https://img.tongyunzn.com/tyxcxtp/sfz.png",
	 ibb:"https://img.tongyunzn.com/tyxcxtp/sff.png",
  },
  formModal:function (){
	 
	
	 var that = this;
	
	
		 // console.log(wx.getStorageSync("region"))
		 // console.log(wx.getStorageSync("address"))
		 // console.log(wx.getStorageSync("transformer"))
		 // console.log(wx.getStorageSync("capacity"))
		 // console.log(wx.getStorageSync("powerConsumptionTime"))
		 
		 // console.log(wx.getStorageSync("typeProof")) 
		 // console.log(wx.getStorageSync("enterpriseName"))	
		 // console.log(wx.getStorageSync("companyPhoto"))
		 // console.log(wx.getStorageSync("equityProveType"))
		 // console.log(wx.getStorageSync("equityProveList"))
		 
		 // console.log(that.data.isshowd)
		 // console.log(that.data.imgz)
		 // console.log(that.data.ownerName)
		 // console.log(that.data.ownerIdCard)
		 // console.log(that.data.applicantPhone)		
		if(this.data.isshowd=="请选择")
		{
					wx.showToast({
						title: "请选择法人证件类型",
						icon: "none",
						duration: 2000,
					});
					return false;	  
		}
		var imgss = that.data.imgz;
		console.log(imgss.length)
		if (imgss.length <=0) {
			wx.showToast({
			    title: "请上传法人身份证件照",
			    icon: "none",
			    duration: 2000,
			});
			return false;		
		}
		
			if (!this.data.ownerName) {
				wx.showToast({
					title: "姓名不得为空",
					icon: "none",
					duration: 2000,
				});
				return false;
			}
			if (!this.data.applicantPhone) {
				wx.showToast({
					title: "手机号不得为空",
					icon: "none",
					duration: 2000,
				});
				return false;
			}
			if (this.data.applicantPhone.length != 11) {
				if (util.phone(this.data.applicantPhone)) {
					wx.showToast({
						title: "手机号位数不正确",
						icon: "none",
						duration: 2000,
					});
				}
				return false;
			}
			if (util.phone(this.data.applicantPhone)) {
				wx.showToast({
					title: "手机号格式不正确",
					icon: "none",
					duration: 2000,
				});
				return false;
			} 
		 wx.request({
		     url:  app.globalData.baseUrl+"/ty/heatingApplet/newclothes/addNewClothes",
		     method: "post",
		     header: {
		         "content-type": "application/json", // 默认值
		         "token":app.globalData.token
		     },
		     data: {
		         type: "2",
		         region: wx.getStorageSync("region"),
		         address: wx.getStorageSync("address"),
		 		 powerConsumptionTime: wx.getStorageSync("powerConsumptionTime"),
		 	 	 equityProveType: wx.getStorageSync("equityProveType"),
		 		 documentType: that.data.isshowd,  //that.data.isshowd
		 		 ownerName: that.data.ownerName,				
		 		 ownerIdCard: that.data.ownerIdCard,
		 		 applicantPhone: that.data.applicantPhone,
		 		 transformer: wx.getStorageSync("transformer"),
		 		 capacity: wx.getStorageSync("capacity"),
		 		 typeProof: wx.getStorageSync("typeProof"),				
		 		 enterpriseName: wx.getStorageSync("enterpriseName"), //企业名称
		 		 installLocationList: [],//List //非
		 		 companyPhoto: wx.getStorageSync("companyPhoto"),   //企业主体照片
		 		 equityProveList: wx.getStorageSync("equityProveList"), //产权证明照片List
		 		 authorizationPhoto: '',   //非
		 		 identityProveList: that.data.imgz, //List法人身份证件照
		     },			
		     success(res){
		         if (res.data.status == "0000") {
					wx.setStorageSync("region",null)
					wx.setStorageSync("address",null)
					wx.setStorageSync("transformer",null)
					wx.setStorageSync("capacity",null)
					wx.setStorageSync("powerConsumptionTime",null)					
					wx.setStorageSync("typeProof",null) 
					wx.setStorageSync("enterpriseName",null)	
					wx.setStorageSync("companyPhoto",null)
					wx.setStorageSync("equityProveType",null)
					wx.setStorageSync("equityProveList",null)
					wx.showToast({
					    title: res.data.message,
					    icon: "none",
					    duration: 2000,
					 });
		            setTimeout(
		              function () {
		             wx.switchTab({url:"../account/account"})
		               }, 
		              2000) 
		         }else{
		             wx.showToast({
		                 title: res.data.message,
		                 icon: "none",
		                 duration: 2000,
		               });
		         }
		        
		     }
		 })
	 
		
	 
  },
  choosezImg: function (e) {
	  if(this.data.isshowd=="请选择")
	  {
	  			wx.showToast({
	  				title: "请选择类型",
	  				icon: "none",
	  				duration: 2000,
	  			});
	  			return false;	  
	  }
	  var imgs = this.data.imgzz;
	  if (imgs.length >= 6) {
	  	wx.showToast({
	  	    title: "最多可上传6张照片",
	  	    icon: "none",
	  	    duration: 2000,
	  	});
	  	return false;		
	  }
    		this.up("z");	
  },
  chooseiaImg: function (e) {
  	      
    		this.ups("ia");
  },
  chooseibImg: function (e) {
  	 
    		this.ups("ib");	
  },
  ups:function(t)
  {
  	var that = this;
  	
  	wx.chooseImage({
  	  // count: 1, // 默认9
  	  sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
  	  sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
  	  success: function (res) {
  		// 返回选定照片的本地文件路径列表，tempFilePath可以作为img标签的src属性显示图片
  			var tempFilePaths = res.tempFilePaths;
  			    var imgz = that.data.imgz;
  				var imgzz = that.data.imgzz;
  				 var imgs = that.data.imgs;		
  		// console.log(tempFilePaths + '----');
  			    if(t=="z"){
  					var imgstr={"photo":tempFilePaths[0]}
  					imgzz.push(imgstr);
  					that.setData({
  					   imgzz: imgzz
  					});
  					that.toBases(tempFilePaths[0],"z")		
  				}
  				else if(t=="ia"){			
  					that.setData({
  					  iaa: tempFilePaths[0]
  					});
  					that.toBases(tempFilePaths[0],"ia")	
  				}
  				else if(t=="ib"){
  					that.setData({
  					  ibb: tempFilePaths[0]
  					});				
  					that.toBases(tempFilePaths[0],"ib")			
  				}
  				
  	  }
  	});
  },
  deleteImg: function (e) {
  	var that = this;
  	var imgz = that.data.imgz;
    var imgzz = that.data.imgzz;
    var index = e.currentTarget.dataset.index;
  	imgz.splice(index, 1);
    imgzz.splice(index, 1);
    that.setData({
  	  imgz: imgz,	
      imgzz: imgzz
    });
  },
  toBases: function (e,t) {
  	var that = this;  
  	var imgz = that.data.imgz; //证明照片集合
  	var imgs = that.data.imgs; //证明照片集合
  	wx.uploadFile({
  			 url: app.globalData.baseUrl+"/ty/heatingApplet/file/upload",
  			 filePath: e,//图片在手机里的存储路径
  			 name: 'file', 
  			 header: {				
  					 "token": app.globalData.token
  			 },			  
  			 success(res) {
  				const data = JSON.parse(res.data);
  				if(data.status == 0){
  					if(t=="ia")
  					{
  						
  						var imgstr={"photo":data.result}
  						imgz[0]=imgstr;					
  						that.setData({
  						  ia: data.result
  						});
  					} else if(t=="ib"){
  						var imgstr={"photo":data.result}
  						imgz[1]=imgstr;						
  						that.setData({
  						  ib: data.result
  						});
  					} else if(t=="z"){
  						var imgstr={"photo":data.result}
  						imgz.push(imgstr);
  						that.setData({
  						   imgz: imgz
  						});
  					} 
  				}				
  			 }
  	})
  	
  }, 
  /////////////
  up:function(t)
  {
  	var that = this;
  	// var imgs = this.data.imgs;
  	// if (imgs.length >= 6) {
  	// 	wx.showToast({
  	// 	    title: "最多可上传6张照片",
  	// 	    icon: "none",
  	// 	    duration: 2000,
  	// 	});
  	// 	return false;		
  	// }
  	wx.chooseImage({
  	  // count: 1, // 默认9
  	  sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
  	  sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
  	  success: function (res) {
  		// 返回选定照片的本地文件路径列表，tempFilePath可以作为img标签的src属性显示图片
  			var tempFilePaths = res.tempFilePaths;
  			
  				var imgz = that.data.imgz;
				var imgzz = that.data.imgzz;
  		// console.log(tempFilePaths + '----');
  			  
  					// for (var i = 0; i < tempFilePaths.length; i++) {
  					//   if (imgz.length >= 9) {
  					// 	that.setData({
  					// 	  imgz: imgz
  					// 	});
  					// 	return false;
  					//   } else {
  					// 	var imgstr={"photo":tempFilePaths[i]}  
  					// 	imgz.push(imgstr);
  					//   }
  					// }
					var imgstr={"photo":tempFilePaths[0]}
					imgzz.push(imgstr);
					that.setData({
					   imgzz: imgzz
					}); 
					that.toBase(tempFilePaths[0],"z")  					
  				
  	  }
  	});
  },
   toBase: function (e,t) {
   	var that = this;
   	var imgc = that.data.imgc; //企业主体照片
   	var imgz = that.data.imgz; //证明照片集合
   	wx.uploadFile({
   			 url: app.globalData.baseUrl+"/ty/heatingApplet/file/upload",
   			 filePath: e,//图片在手机里的存储路径
   			 name: 'file', 
   			 header: {				
   					 "token": app.globalData.token
   			 },			  
   			 success(res) {
   				const data = JSON.parse(res.data);
   				if(data.status == 0){
					var imgstr={"photo":data.result}
					imgz.push(imgstr);
					that.setData({
					   imgz: imgz
					});
   				}				
   			 }
   	})
   	
   }, 
  onBtna:function (){
  	this.setData({showd:true,isbg:true})
  },
  selBtnb:function (res){
	  if(this.data.itemsshowd[res.currentTarget.id].message=="身份证")
	  {
	  		   this.setData({showpicaModal:false,showpicbModal:true})
	  }
	  else
	  {
	  		   this.setData({showpicaModal:true,showpicbModal:false})
	  }
		this.setData({isshowd:this.data.itemsshowd[res.currentTarget.id].message})
		this.setData({showd:false,isbg:false})	
		var that = this;
		var imgz = that.data.imgz;
		var imgzz = that.data.imgzz;		
		for (var i = 0; i < imgz.length; i++) {
					imgz.splice(i);
					imgzz.splice(i);
		}
		that.setData({
		   imgzz: imgzz
		});
  },
  cloBtnb:function (){
  	this.setData({showd:false,isbg:false})
  },
//取消框
oshowModal:function (){
	this.setData({showModal:true})
},
cshowModal:function (){
	this.setData({showModal:false})
},
coshowModal:function (){
	wx.switchTab({url:"../account/account"})
},

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
            
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {
       
  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  },

})