// pages/form/pera.js
Page({

  /**
   * 页面的初始数据
   */
  data: {
       showAddressModel: false,
	   addresslist: [],
	   showd: false, //是否是住宅用电
	   isshowd:'请选择',
	   itemsshowd:  [{
	         message: '是',
	       },{
	         message: '否'
	       }],
	   isbg:false,
	   imgz:[],
	   token:'MTkwLTE2MDEyNTQ1MDc0NjEtNmZmNTBiMWI3ZmZmNGU0Nzg1MTQ2NzM0NmE1Njg1MDA=',
	   		  
  },
 btnForm:function (){
  	var _this = this 
	if (!_this.data.area) {
	    wx.showToast({
	        title: "地区不得为空",
	        icon: "none",
	        duration: 2000,
	    });
	    return false;
	}
	if (!_this.data.address) {
	    wx.showToast({
	        title: "详细地址不得为空",
	        icon: "none",
	        duration: 2000,
	    });
	    return false;
	}
	if(_this.data.isshowd=="是")
	      transformerInt=1
	else if(_this.data.isshowd=="否")
	      transformerInt=2
	else
	{
		wx.showToast({
		    title: "是否是住宅用电不得为空",
		    icon: "none",
		    duration: 2000,
		});
		return false;
	}
	var transformerInt
	wx.setStorageSync("region",_this.data.regionId)
	wx.setStorageSync("address",_this.data.address)
	wx.setStorageSync("transformer",transformerInt)
	wx.setStorageSync("capacity",_this.data.capacity)
	wx.setStorageSync("installLocationList",_this.data.imgz)
	wx.setStorageSync("powerConsumptionTime",_this.data.currentDate)
	wx.navigateTo({url:"./perb"})
},
choosezImg: function (e) {
  		this.up("z");	
},
up:function(t)
{
	var that = this;
	// var imgs = this.data.imgs;
	// if (imgs.length >= 6) {
	// 	wx.showToast({
	// 	    title: "最多可上传6张照片",
	// 	    icon: "none",
	// 	    duration: 2000,
	// 	});
	// 	return false;		
	// }
	wx.chooseImage({
	  // count: 1, // 默认9
	  sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
	  sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
	  success: function (res) {
		// 返回选定照片的本地文件路径列表，tempFilePath可以作为img标签的src属性显示图片
			var tempFilePaths = res.tempFilePaths;
			var imgs = that.data.imgs;
				var imgc = that.data.imgc;
				var imgz = that.data.imgz;		
		// console.log(tempFilePaths + '----');
			    if(t=="c")
				{
					that.setData({
					  imgc: tempFilePaths[0]
					});		
				}
				else if(t=="z"){
					for (var i = 0; i < tempFilePaths.length; i++) {
					  if (imgz.length >= 9) {
						that.setData({
						  imgz: imgz
						});
						return false;
					  } else {
						var imgstr={"photo":tempFilePaths[i]}  
						imgz.push(imgstr);
					  }
					} 
					that.setData({
					  imgz: imgz
					});
				}
	  }
	});
}, 
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {

  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  }, 
  onBtna:function (){
  	this.setData({showd:true,isbg:true})
  },
  selBtnb:function (res){
  	this.setData({isshowd:this.data.itemsshowd[res.currentTarget.id].message})
  	this.setData({showd:false,isbg:false})		
  },
  cloBtnb:function (){
  	this.setData({showd:false,isbg:false})
  },
  onRegionTap: function (e) {
      wx.showLoading({
          title: "加载中...",
      })
      var _this = this
      var parentId = e.currentTarget.dataset.id || ''
      var name = e.currentTarget.dataset.name || ''
      var url = parentId ? `/ty/heatingApplet/address/addressList?parentId=${parentId}` : `/ty/heatingApplet/address/addressList`;
  	
      this.setAreaTap(name);
      wx.request({
          url: "https://testxny.tongyunzn.com" + url,
          method: "get",
          header: {
              "content-type": "application/x-www-form-urlencoded", // 默认值
              "token":_this.data.token},
          success: function (res) {
  		 
              if (res.data.status == "0000") {
                  _this.setData({
                      addressView: res.data.result,
                      showAddressModel: true,
                  })
  
                  if (res.data.result.length == 0) {
                      var area = ''
                      for(var i=0; i < _this.data.areaArray.length-1; i++){
                          area += _this.data.areaArray[i]
                      }
                      _this.setData({
                          showAddressModel: false,
                          regionId: parentId,
                          area: area
                      })
                      wx.removeStorageSync('areaArray')
                  }
              }
          },
          complete: function () {
              wx.hideLoading()
          }
      })
  },
  setAreaTap: function (name) {
      var select = "请选择"
      var areaArray = wx.getStorageSync('areaArray') || []
      areaArray.pop()
      name !== '' && areaArray.push(name)
      areaArray.push(select)
      wx.setStorageSync('areaArray', areaArray)
      this.setData({
          areaArray: areaArray
      })
  },
  closedModel: function (e) {
      this.setData({
          showAddressModel: false,
      });
      wx.showTabBar({
          animation: false,
          success: (res) => {
              console.log("showTabBar", res);
          },
      });
      wx.removeStorageSync('areaArray')
  },
  changeDate:function(e){      
      var date = e.detail.value;
      this.setData({
        currentDate:date
      })
    },
})