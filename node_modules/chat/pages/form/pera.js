var app = getApp()
Page({

  /**
   * 页面的初始数据
   */
  data: {
       showAddressModel: false,
	   addresslist: [],
	   showd: false, //是否是住宅用电
	   isshowd:'请选择',
	   itemsshowd:  [{
	         message: '是',
	       },{
	         message: '否'
	       }],
	   isbg:false,
	   imgz:[],
	   imgzz:[],
	   token:'MTkwLTE2MDE0MjY5Njg3MTEtZjg3ZThiMzlkMmQ0NDk3ODllZTE2ODYyNzY0MjU1Y2Q=',
  },
 btnForm:function (){
  	var _this = this 
	var transformerInt
	if (!_this.data.area) {
	    wx.showToast({
	        title: "地区不得为空",
	        icon: "none",
	        duration: 2000,
	    });
	    return false;
	}
	if (!_this.data.address) {
	    wx.showToast({
	        title: "详细地址不得为空",
	        icon: "none",
	        duration: 2000,
	    });
	    return false;
	}
	if(_this.data.isshowd=="是")
	      transformerInt=1
	else if(_this.data.isshowd=="否")
	      transformerInt=2
	else
	{
		wx.showToast({
		    title: "是否是住宅用电不得为空",
		    icon: "none",
		    duration: 2000,
		});
		return false;
	}
	
	wx.setStorageSync("region",_this.data.regionId)
	wx.setStorageSync("address",_this.data.address)
	wx.setStorageSync("transformer",transformerInt)
	wx.setStorageSync("capacity",_this.data.capacity)
	wx.setStorageSync("installLocationList",_this.data.imgz)
	wx.setStorageSync("powerConsumptionTime",_this.data.currentDate)
	 wx.navigateTo({
	      url: '/pages/form/perb',
	      success: function(res) {
			  console.log("ok")
		  },
	      fail: function(res) {
			  console.log(fail)
		  },
	      complete: function(res) {},
	    })
	
},
choosezImg: function (e) {
	var imgs = this.data.imgzz;
	if (imgs.length >= 6) {
		wx.showToast({
		    title: "最多可上传6张照片",
		    icon: "none",
		    duration: 2000,
		});
		return false;		
	}
  		this.up("z");	
},
up:function(t)
{
	var that = this;
	
	wx.chooseImage({
	  // count: 1, // 默认9
	  sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
	  sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
	  success: function (res) {
		// 返回选定照片的本地文件路径列表，tempFilePath可以作为img标签的src属性显示图片
			var tempFilePaths = res.tempFilePaths;
			var imgs = that.data.imgs;
				var imgz = that.data.imgz;
				var imgzz = that.data.imgzz;		
		
			  var imgstr={"photo":tempFilePaths[0]}
			  imgzz.push(imgstr);
			  that.setData({
			     imgzz: imgzz
			  }); 
			  that.toBase(tempFilePaths[0],"z")  	
	  }
	});
},
deleteImg: function (e) {
	var that = this;
	var imgz = that.data.imgz;
    var imgzz = that.data.imgzz;
    var index = e.currentTarget.dataset.index;
	imgz.splice(index, 1);
    imgzz.splice(index, 1);
    that.setData({
	  imgz: imgz,	
      imgzz: imgzz
    });
},
toBase: function (e,t) {
   	var that = this;   
   	var imgz = that.data.imgz; //证明照片集合
	
		wx.uploadFile({
				 url: app.globalData.baseUrl+"/ty/heatingApplet/file/upload",				
				 filePath: e,//图片在手机里的存储路径
				 name: 'file',
				 header: {
					 "token": app.globalData.token
				 },			  
				 success(res) {
					const data = JSON.parse(res.data);
					
					if(data.status == 0){
						console.log(data)
						var imgstr={"photo":data.result}
						imgz.push(imgstr);
						that.setData({
						   imgz: imgz
						});
					}				
				 }
		})
   	
   }, 
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
	    //console.log(app.globalData.token)
		wx.setStorageSync("region",null)
		wx.setStorageSync("address",null)
		wx.setStorageSync("transformer",null)
		wx.setStorageSync("capacity",null)
		wx.setStorageSync("installLocationList",null)
		wx.setStorageSync("powerConsumptionTime",null)
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  }, 
  onBtna:function (){
  	this.setData({showd:true,isbg:true})
  },
  selBtnb:function (res){
  	this.setData({isshowd:this.data.itemsshowd[res.currentTarget.id].message})
  	this.setData({showd:false,isbg:false})		
  },
  cloBtnb:function (){
  	this.setData({showd:false,isbg:false})
  },
  onRegionTap: function (e) {
      wx.showLoading({
          title: "加载中...",
      })
      var _this = this
      var parentId = e.currentTarget.dataset.id || ''
      var name = e.currentTarget.dataset.name || ''
      var url = parentId ? `/ty/heatingApplet/address/addressList?parentId=${parentId}` : `/ty/heatingApplet/address/addressList`;
  	
      this.setAreaTap(name);
      wx.request({
          url: app.globalData.baseUrl+ url,
          method: "get",
          header: {
              "content-type": "application/x-www-form-urlencoded", // 默认值
              "token":app.globalData.token},
          success: function (res) {
  		 
              if (res.data.status == "0000") {
                  _this.setData({
                      addressView: res.data.result,
                      showAddressModel: true,
                  })
  
                  if (res.data.result.length == 0) {
                      var area = ''
                      for(var i=0; i < _this.data.areaArray.length-1; i++){
                          area += _this.data.areaArray[i]
                      }
                      _this.setData({
                          showAddressModel: false,
                          regionId: parentId,
                          area: area
                      })
                      wx.removeStorageSync('areaArray')
                  }
              }
          },
          complete: function () {
              wx.hideLoading()
          }
      })
  },
  setAreaTap: function (name) {
      var select = "请选择"
      var areaArray = wx.getStorageSync('areaArray') || []
      areaArray.pop()
      name !== '' && areaArray.push(name)
      areaArray.push(select)
      wx.setStorageSync('areaArray', areaArray)
      this.setData({
          areaArray: areaArray
      })
  },
  closedModel: function (e) {
      this.setData({
          showAddressModel: false,
      });
      wx.showTabBar({
          animation: false,
          success: (res) => {
             // console.log("showTabBar", res);
          },
      });
      wx.removeStorageSync('areaArray')
  },
  changeDate:function(e){      
      var date = e.detail.value;
      this.setData({
        currentDate:date
      })
    },
})