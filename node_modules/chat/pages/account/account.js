const app = getApp();
Page({
  /**
   * 页面的初始数据
   */
  data: {
    isoped: false,
    isoped2: false,
    baseTitle:"基本信息",
    ishow:true,
    accountTitle:"账户中心",
    addressTitle:"联系地址",
    userInfo:{},
    amount:0,
    balance:0,
    withdrawalMoney:0,
    userName: "请登录",
    userIcon:'',
    img:app.globalData.staticImg,
    isInviteStatus:1
  },
  handleEditName:function(){
    wx.navigateTo({
      url: '../accountedit/accountedit?sign=nikeName',
    })
  },
  getPhoneNumber: function (res) {
    if (res.detail.errMsg == "getPhoneNumber:fail user deny") {
      wx.showToast({
        icon: 'none',
        title: '请重新授权获取手机号',
        duration: 2000
      })
      return false
    }
    this.setData({
      isoped: false
    })
    //console.log('获取手机号————————',res.detail,res.detail.encryptedData,res.detail.ivß)
    var that = this;
    wx.request({
      url: app.globalData.baseUrl + "/ty/heatingApplet/user/phoneNumber",
      method: "post",
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      data: {
        encryptedData: res.detail.encryptedData,
        iv: res.detail.iv,
        sessionKey: app.globalData.sessionKey
      },
      success: (res) => {
        if (res.data.status != '0000') {
          wx.showToast({
            title: res.data.message,
            icon: "none",
            duration: 2000
          })
        }
        //console.log('获取手机号22——————————',res.data.result)
        wx.request({
          url: app.globalData.baseUrl + "/ty/heatingApplet/user/perfectUser",
          method: "POST",
          data: {
            id: app.globalData.userId,
            phone: res.data.result
          },
          header: {
            "content-type": "application/json", // 默认值
            token: app.globalData.token,
          },
          success: (res) => {
            if (res.data.status != '0000') {
              wx.showToast({
                title: res.data.message,
                icon: "none",
                duration: 2000
              })
            }
            //  console.log("baoun_", res);
          },
        });

      }
    })
  },
  getUserInfo:function(){
    var that = this;
    wx.request({
      url: app.globalData.baseUrl + "/ty/heatingApplet/user/userinfo",
      method: "POST",
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      data: {
        id:app.globalData.userId
      },
      success: (res) => {
        let amount = res.data.result.amount/100
        amount = amount.toFixed(2)
        let balance= res.data.result.balance/100
        balance = balance.toFixed(2)
        let withdrawalMoney =res.data.result.withdrawalMoney/100
        withdrawalMoney=withdrawalMoney.toFixed(2)
        that.setData({
          userInfo: res.data.result,
          amount:amount,
          balance:balance,
          withdrawalMoney:withdrawalMoney
        });

        wx.setStorage({
          data: res.data.result.phone,
          key: 'phone',
        });

        let name = res.data.result.name //用户名
        let phone = res.data.result.phone //手机号
        if (res.data.result.phone) {
          that.setData({
            // isoped:false,
            isoped2: true

          })
        }
        wx.setStorage({
          data: name || '',
          key: 'userName',
        })
        wx.setStorage({
          data: phone || '',
          key: 'phone',
        })

        wx.hideLoading({
          icon:"none"
        })
        wx.stopPullDownRefresh()
      },
    });
  },
  handleEdit:function(e){
    if(e.currentTarget.dataset.sign === 'amount'){//累计获得金额

    }else if(e.currentTarget.dataset.sign ==='balance'){//余额

    }else if(e.currentTarget.dataset.sign === 'withdrawalMoney'){//已提现金额

    }else{
      wx.navigateTo({
        url: '../accountedit/accountedit?sign='+e.currentTarget.dataset.sign+'&val='+e.currentTarget.dataset.val,
      })
    }
   
  },


  bindGetUserInfo: function (res) {
    var that = this;
    console.log(res )
    if (res.detail.errMsg === "getUserInfo:fail auth deny") {
      wx.showToast({
        icon: "none",
        title: "请重新进行微信授权!",
        duration: 2000,
      });
      return false;
    }
    if(!that.data.isoped2){
      that.setData({
        isoped:true
      })
    }
  //  console.log('wechat__授权___',res)
    var userInfo = res.detail.userInfo;
        wx.setStorage({
          key: "userName",
          data: userInfo.nickName,
        });
        wx.setStorage({
          key: "userIcon",
          data: userInfo.avatarUrl,
        });
        that.setData({
          userName: userInfo.nickName,
          userIcon: userInfo.avatarUrl
        });

        var obj = {};
        obj.id = app.globalData.userId;
        obj.name = userInfo.nickName;
        obj.sex = userInfo.gender;
        //用户完善个人信息
        wx.request({
          url: app.globalData.baseUrl + "/ty/heatingApplet/user/perfectUser",
          method: "POST",
          data: obj,
          header: {
            "content-type": "application/json", // 默认值
            token: app.globalData.token,
          },
          success: (res) => {
            that.getUserInfo()
          },
        });
  },

  isInvite:function(){//是否有邀请数据
    let that =this
    wx.request({
      url: app.globalData.baseUrl + "/ty/heatingApplet/invite/myInviteList",
      method: "POST",
      data: {
        userId:app.globalData.userId,
        pageNo:1,
        pageSize:10,
      },
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      success: (res) => {
        if(res.data.info !=1){  //  1无邀请记录    null   有邀请记录
          that.setData({
            isInviteStatus:2
          })
        }
      },
    });
  },

  goAccount:function(){
    wx.navigateTo({
      url: '/pages/userinfoedit/userinfoedit',
    })
  },


  inviteBtn: function () {
    //判断是否已有已邀请数据
    let url;
    if(this.data.isInviteStatus==1){
      url = "../myinvite/myinvite"
    }else{
      url = "../myinvited/myinvited"
    }
    wx.navigateTo({
      url: url
    });
  },

  rewardBtn: function () {
    wx.navigateTo({
      url: "../myreward/myreward",
    });
  },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    const that = this;
    // wx.showLoading({
    //   title: '页面加载中...',
    // })
    this.isInvite()
    // this.getUserInfo()
    wx.getStorage({
      key: 'userName',
      success (res) {
        that.setData({
          userName:res.data
        })
      }
    }) 
    wx.getStorage({
      key: 'userIcon',
      success (res) {
        that.setData({
          userIcon:res.data
        })
      }
    }) 
  },
  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {
    // this.getUserInfo()
  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {
    wx.showLoading({
      title: '页面重新加载中...',
    })
    this.getUserInfo()
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {

  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {

  }
})