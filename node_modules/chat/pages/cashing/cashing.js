const app = getApp();
const util = require("../../utils/util");
Page({

  /**
   * 页面的初始数据
   */
  data: {
    applyed:false,
    balance:'0',
    money:'0',
    userName:'',
    cardNum:'',
    cardName:''
  },
  goUrl:function(){
    wx.navigateBack({
      delta: 1
    })
  },
  getUserInfo:function(){
    var that = this;
    wx.request({
      url: app.globalData.baseUrl + "/ty/heatingApplet/user/userinfo",
      method: "POST",
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      data: {
        id:app.globalData.userId
      },
      success: (res) => {
        // bankCardNo": "6226880310063979",
        // "bankUserName": "红玛瑙",
        // "bankName": "中信银行信用卡中心"
        that.setData({
          userName:res.data.result.bankUserName,
          cardNum:res.data.result.bankCardNo,
          cardName:res.data.result.bankName
        });
        wx.hideLoading({
          icon:"none"
        })
        wx.stopPullDownRefresh()
      },
    });
  },
  //查看提取记录
  cashRecord:function(){
    wx.navigateTo({
      url: '../myreward/myreward?active='+false,
    })
  },
  getMoney:function(e){
    this.setData({
      money: e.detail.value,
    });
  },
  getUserName:function(e){
    this.setData({
      userName: e.detail.value,
    });
  },
  getCardNum:function(e){
    this.setData({
      cardNum: e.detail.value,
    });
  },
  getCardName:function(e){
    this.setData({
      cardName: e.detail.value,
    });
  },
  getCardInfo:function(e){
  //  console.log('e.detail.value,',e.detail.value,)
    var that = this
    wx.request({
      url: app.globalData.baseUrl + "/ty/heatingApplet/bank/carkByBin",
      method: "post",
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
       // token:"MzItMTU5MjcyNzU4NzY3MS0xZGRhMTcyMGVjZTE0OWYyOWFlYWJiOTk4MzFhMWE5MQ=="
      },
      data:{
        cardNu:e.detail.value
      },
      success: (res) => {
      //  console.log("银行卡名称 ", res, res.data.result);
        if(res, res.data.result){
          that.setData({
            cardName: res.data.result,
          });
        }

      },
    });
  },
  cashToCard:function(e){
    var that = this;
    if (!this.data.money) {
      wx.showToast({
        title: "提现金额不得为空",
        icon: "none",
        duration: 2000,
      });
      return false;
    }
     if(this.data.money/1 >this.data.balance/1){
      wx.showToast({
        title: "提现金额不能大于奖励余额",
        icon: "none",
        duration: 2000,
      });
      return false;
    }
    if (!this.data.userName) {
      wx.showToast({
        title: "姓名不得为空",
        icon: "none",
        duration: 2000,
      });
      return false;
    }
    if (util.chinese(this.data.userName)) {
      wx.showToast({
        title: "姓名必须为中文",
        icon: "none",
        duration: 2000,
      });
      return false;
    }
    if (!this.data.cardNum) {
      wx.showToast({
        title: "卡号不得为空",
        icon: "none",
        duration: 2000,
      });
      return false;
    }
    if (!this.data.cardName) {
      wx.showToast({
        title: "卡名称不得为空",
        icon: "none",
        duration: 2000,
      });
      return false;
    }
    wx.request({
      url: app.globalData.baseUrl + "/ty/heatingApplet/withdrawal/withdrawalApply",
      method: "post",
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      data:{
        userId:app.globalData.userId.toString(),
        position:"2",
        money:that.data.money,
        bankCode:that.data.cardNum,
        userName:that.data.userName,
        bankName:that.data.cardName
      },
      success: (res) => {
        if(res.data.status !="0000"){
          wx.showToast({
            title: res.data.message,
            icon: "none",
            duration: 2000,
          });
        }else{
          that.setData({
            applyed:true
          })
          // wx.showToast({
          //   title: res.data.message,
          //   icon: "none",
          //   duration: 2000,
          // });
          ///
          // setTimeout(function(){
          //
          // },2000)
        }


        // if(res, res.data.result){
        //   that.setData({
        //     cardName: res.data.result,
        //   });
        // }

      },
    });



  },
  getBalance:function(){//获取奖励余额
    var that =this
    let data ={
      userId:app.globalData.userId,
      c:1
    }
   // data =JSON.stringify(data)
    wx.request({
      url: app.globalData.baseUrl + "/ty/heatingApplet/data/wallet",
      method: "post",
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
       // token:"MzItMTU5MjcyNzU4NzY3MS0xZGRhMTcyMGVjZTE0OWYyOWFlYWJiOTk4MzFhMWE5MQ=="
      },
      data: data,
      success: (res) => {
      //  console.log("getProductData", res, res.data.result);
        let balance = res.data.result.balance
        if(balance>0){
          that.setData({
            balance: balance
          });
        }

      },
    });
  },
  cancel:function(){
    wx.navigateBack({
      delta: 1
    })
  },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    this.getBalance()
    this.getUserInfo()
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {

  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {

  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {

  }
})
