const util = require("../../utils/util");
var bmap = require("../../utils/bmap-wx.min");
var wxMarkerData = [];
const app = getApp();
Page({
  data: {
    // id:'',
    index: 0, //picke
    code6:false,
    applyed: false,
    apped: false,
   // GetAddressAgain: "",
    title1: "意向产品",
    title2: "联系信息",
    mId: "",
    currentProduct: [],
    characteristicArr: [],
    userName: "",
    userPhone: "",
    isAutoAddress: 1,
   // isAutoAddressSub:1,
    address: "",
    inviteCode: true,
    invCoded: "",
    //add
    showBuyModel: false,
    list: [],
    subList: [],
    selectedImg:"",
    selectedName: "",
    selectedPrice: "",
    selectedArea: "",
    selectedPower:"",
    partsId:'',//选中的配件id
    active: 0,
    activeSub: 0
	
  },
  goUrl2:function(){
    var that = this;
    that.setData({
      code6:false
    })
  },
  handleSelected: function (e) {
    var that = this;
    console.log("click_______", e, e.currentTarget.dataset.id);
    let id = e.currentTarget.dataset.id;
    var arr=[]
    if(arr.length>1){
      arr.pop()
    }
    for (let i = 0; i < that.data.list.length; i++) {
      if (that.data.list[i].id == id) {
        console.log(that.data.list[i]);
        arr.push(that.data.list[i])
        that.setData({
          currentProduct:arr,
          active: i,
          selectedImg:app.globalData.imgUrl+that.data.list[i].photo1,
          selectedName: that.data.list[i].name,
          subList: that.data.list[i].parts,
         // selectedPrice: that.data.list[i].parts[0].money,
         // selectedArea:that.data.list[i].parts[0].heatingArea,

          // selectedPrice: that.data.subList[0].money,
          // selectedArea: that.data.subList[0].heatingArea,
          // selectedPower:that.data.subList[0].power,
          // partsId:that.data.subList[0].id,
          activeSub: 0,
        });
        setTimeout(function(){
          that.setData({
            selectedPrice: that.data.subList[0].money,
            selectedArea: that.data.subList[0].heatingArea,
            selectedPower:that.data.subList[0].power,
            partsId:that.data.subList[0].id,
          })
        },50)
        break;
      }
    }
  },
  handleSubSelected: function (e) {
    var that = this;
    let index = e.currentTarget.dataset.id;
    console.log('tttt',e)
    for (let i = 0; i < that.data.subList.length; i++) {
      if (index == i) {
        that.setData({
          selectedPrice: that.data.subList[i].money,
          selectedArea: that.data.subList[i].heatingArea,
          selectedPower:that.data.subList[i].power,
          partsId:that.data.subList[i].id,
          activeSub: i,
        });
      }
    }
    console.log("click2_______", e, e.currentTarget.dataset.id);
  },
  goUrl: function () {
    wx.redirectTo({
      url: "../myinvited/myinvited",
    });
  },
  getUserName: function (e) {
    this.setData({
      userName: e.detail.value,
    });
  },
  getUserPhone: function (e) {
    this.setData({
      userPhone: e.detail.value,
    });
  },
  getLocation: function (e) {
    //获取位置
    //console.log('点击获取事件参数',e.currentTarget.dataset.id)
    var _that = this;
    
    wx.authorize({
      scope: "scope.userLocation",
      success(res) {
        //--------------------baidu map start
        var BMap = new bmap.BMapWX({
          ak: app.globalData.baiduMapKey,
        });
        var fail = function (data) {
          console.log('位置授权失败')
          //    console.log(data)
        };
        var success = function (data) {
          console.log('位置授权成功')
          wxMarkerData = data.wxMarkerData;
          _that.setData({
            address: wxMarkerData[0].address,
            isAutoAddress: 2
          });

          wx.setStorage({
            key: "isAutoAddress",
            data: 1,
          });
        };
        BMap.regeocoding({
          fail: fail,
          success: success,
        });
        //----------------------------baidu map end
      },
      fail(res){
        console.log('yong位置授权失败11111')
        _that.setData({
          isAutoAddress:3
        })
        wx.setStorage({
          key: "isAutoAddress",
          data: 3,
        });
      }
    });
  },
  handleAddress: function (e) {
    this.setData({
      address: e.detail.value,
    });
  },
  handleInvCode: function (e) {
    var that =this;
    this.setData({
      invCode: e.detail.value,
    });
    if(e.detail.value.length ==6){
      wx.showLoading({
        title: '验证码校验中...',
      })
      wx.request({
        url:
          app.globalData.baseUrl +"/ty/heatingApplet/user/verifyReferralCode",
        method: "POST",
        data: {
          invCode: e.detail.value,
        },
        header: {
          "content-type": "application/json", // 默认值
          token: app.globalData.token,
        },
        success: (res) => {
              console.log('邀请码存在——————',res.data)
              
              if(res.data.status !='0000'){
                wx.showToast({
                  title: res.data.message,
                  icon: "none",
                  duration: 2000,
                });
              }else{
                wx.hideLoading({
                  complete: (res) => {},
                })
                if(!res.data.result){
                  wx.hideLoading({
                    complete: (res) => {},
                  })
                  // wx.showToast({
                  //   title: "此邀请码不正确!",
                  //   icon: "none",
                  //   duration: 2000,
                  // });
                  that.setData({
                    code6:true
                  })
                }
              }
        }
      })
    }
  },
  handleForm: function () {
    var that = this;
    //提交
    if (!this.data.userName) {
      wx.showToast({
        title: "姓名不得为空",
        icon: "none",
        duration: 2000,
      });
      return false;
    }
    // if (util.chinese(this.data.userName)) {
    //   wx.showToast({
    //     title: "姓名必须为中文",
    //     icon: "none",
    //     duration: 2000,
    //   });
    //   return false;
    // }
    if (!this.data.userPhone) {
      wx.showToast({
        title: "手机号不得为空",
        icon: "none",
        duration: 2000,
      });
      return false;
    }
    if (this.data.userPhone.length != 11) {
      if (util.phone(this.data.userPhone)) {
        wx.showToast({
          title: "手机号位数不正确",
          icon: "none",
          duration: 2000,
        });
      }
      return false;
    }
    if (util.phone(this.data.userPhone)) {
      wx.showToast({
        title: "手机号格式不正确",
        icon: "none",
        duration: 2000,
      });
      return false;
    }
    if (!this.data.address) {
      wx.showToast({
        title: "地址不得为空",
        icon: "none",
        duration: 2000,
      });
      return false;
    }
    let invCode;
    if (that.data.invCoded) {
      invCode = that.data.invCoded;
    } else {
      invCode = that.data.invCode;
      if (this.data.invCode && this.data.invCode.length !=6) {
        wx.showToast({
          title: "邀请码需是6位",
          icon: "none",
          duration: 2000,
        });
        return false;
      }
    }
    wx.request({
      url:
        app.globalData.baseUrl +
        "/ty/heatingApplet/equipment/requipmentApplication",
      method: "POST",
      data: {
        userId: app.globalData.userId,
        userName: that.data.userName,
        phone: that.data.userPhone,
        address: that.data.address,
        model: that.data.productType,
        type: 1,
        modelId: that.data.mId,
        invCode: invCode,
      //  money:that.data.selectedPrice,
      //  heatingArea:that.data.selectedArea,
      //  power:that.data.selectedPower,
        partsId:that.data.partsId
      },
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      success: (res) => {
        if (res.data.status != "0000") {
          wx.showToast({
            title: res.data.message,
            icon: "none",
            duration: 2000,
          });
        } else {
          that.setData({
          //  isAutoAddress: 3,
            apped: true,
            applyed: true,
          });
          // wx.setStorage({
          //   key: "GetAddressAgain",
          //   data: 2,
          // });
          // wx.setStorage({
          //   key: "isAutoAddress",
          //   data: 2,
          // });
          // wx.showToast({
          //   title: res.data.message,
          //   icon: "none",
          //   duration: 2000,
          // });
        }
      },
    });
  },
  selectProduct: function (e) {
    this.setData({
      showBuyModel: true,
    });
    wx.hideTabBar({
      animation: false,
      success: (res) => {
        console.log("tabbar hide", res);
      },
    });
  },
  closedModel: function (e) {
    this.setData({
      showBuyModel: false,
    });
    wx.showTabBar({
      animation: false,
      success: (res) => {
        console.log("showTabBar", res);
      },
    });
  },
  getUserInfo:function(){//查询用户基础信息
    let that = this
    wx.request({
      url: app.globalData.baseUrl + "/ty/heatingApplet/user/userinfo",
      method: "POST",
      data: {
        id: app.globalData.userId,
      },
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      success: (res) => {
        that.setData({
          userName: res.data.result.name,
          userPhone: res.data.result.phone,
          address: res.data.result.address,
          
        });
        if(res.data.result.address){
          that.setData({
            isAutoAddress:3
          })
          wx.setStorage({
            key: "isAutoAddress",
            data: 3,
          });
        }else{
          wx.getStorage({
            key: 'isAutoAddress',
            success:function(res){
              that.setData({
                isAutoAddress:res.data
              })
            }
          })
        }
        
      },
    });
  },
  
  // bindPickerChange: function (e) { //下拉选择
  //   console.log('点击率')

  //   var that = this;
  //  // console.log('picker发送选择改变，携带值为', e.detail.value)
  //   this.setData({
  //     index: e.detail.value,
  //     id:e.detail.value
  //   })
  //   for(var i=0;i<that.data.characteristicArr.length;i++){
  //     if(that.data.index ==i){

  //         let arr =[]
  //       arr.push(that.data.characteristicArr[i])
  //       that.setData({
  //         currentProduct:arr
  //       })
  //     }
  //   }
  // },
  /**
   * 生命周期函数--监听页面加载
   */

  onLoad: function (options) {
	
    wx.getStorage({
      key: 'isAutoAddress',
      success(res) {
        that.setData({
          isAutoAddress: res.data,
        });
      },

    })
    this.setData({
      applyed: false,
    });
    //  console.log('申请安装接收的参数——————————————————————————options',options)
    var that = this;

    if (app.globalData.invCoded) {
      that.setData({
        invCoded: app.globalData.invCoded,
      });
    }

    if (options.id) {
      this.setData({
        mId: options.id,
      });
    }
    // wx.getStorage({
    //   key: "GetAddressAgain",
    //   success(res) {
    //     that.setData({
    //       GetAddressAgain: res.data,
    //     });
    //   },
    // });
    // wx.getStorage({
    //   key: "isAutoAddress",
    //   success(res) {
    //     that.setData({
    //       isAutoAddress: res.data,
    //     });
    //   },
    // });
    
    
    var arr = [];
    wx.request({
      url: app.globalData.baseUrl + "/ty/heatingApplet/equipment/equipmentList",
      method: "POST",
      data: {},
      header: {
        "content-type": "application/json", // 默认值
        token: app.globalData.token,
      },
      success: (res) => {
        console.log(
          "产品列表————+++++++++————",
          res.data.result,
         // that.data.mId
        );

        if (that.data.mId) {
          for (let i = 0; i < res.data.result.length; i++) {
            //  console.log('卧槽',that.data.mId,res.data.result[i].id.toString())
            if (that.data.mId == res.data.result[i].id.toString()) {
              that.setData({
                index: i,//已无用
              });
              arr.push(res.data.result[i]);
              // that.setData({
              //   mId:arr[i].id
              // })
              that.setData({
                active:i,
                selectedName:res.data.result[i].name,
                selectedImg:app.globalData.imgUrl+res.data.result[i].photo1,
                //selectedImg:app.globalData.staticImg+res.data.result[0].photo3,
                selectedPrice:res.data.result[i].parts[0].money,
                selectedArea: res.data.result[i].parts[0].heatingArea,
                selectedPower:res.data.result[i].parts[0].power,
                partsId:res.data.result[i].parts[0].id
              });
              break;
            }
          }
        } else {
          arr.push(res.data.result[0]);
          console.log('partsId__________________',res.data.result[0].parts[0])
          that.setData({
            mId: arr[0].id,
            selectedName:res.data.result[0].name,
            selectedImg:app.globalData.imgUrl+res.data.result[0].photo1,
            //selectedImg:app.globalData.staticImg+res.data.result[0].photo3,
            selectedPrice:res.data.result[0].parts[0].money,
            selectedArea: res.data.result[0].parts[0].heatingArea,
            selectedPower:res.data.result[0].parts[0].power,
            partsId:res.data.result[0].parts[0].id
          });
        }
        // console.log('_______2020',arr)

        that.setData({
          characteristicArr: res.data.result, //已无用
          currentProduct: arr,
          list:res.data.result,
          subList: res.data.result[0].parts,
          // mId:arr[0].id
        });
        console.log('yyyy',that.data.subList)
        if (res.data.status != "0000") {
          wx.showToast({
            title: res.data.message,
            icon: "none",
            duration: 2000,
          });
        } else {
          // wx.showToast({
          //   title: res.data.message,
          //   icon: "none",
          //   duration: 2000,
          // });
        }
      },
    });
    
    this.getUserInfo()
    
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {},

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function (options) {
    this.getUserInfo()
  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {},

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {},

onShareAppMessage: function () {
		  this.wxLogin()
		  return {
			title: '通云煤改电',
		    path: '/pages/index/index?invCode='+wx.getStorageSync("invCodes"),
			success: function (res) {
			   wx.showToast({ 
				icon: 'success',
			     title: "转发成功",
			     duration:2000
			   })  
			},
			fail: function (res) {
				wx.showToast({
				  icon: 'success',
				  title: res,
				  duration:2000
				})  
			},
		  }	
	},
	onShareTimeline: function (res) {
		  this.wxLogin()
		  return {
			title: '通云煤改电',
		    path: '/pages/index/index?invCode='+wx.getStorageSync("invCodes"),
			success: function (res) {
			    wx.showToast({
			      title: "转发成功",
			      duration:2000
			    })  
			},
		  }	
	},
});
