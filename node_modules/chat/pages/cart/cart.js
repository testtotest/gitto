// pages/cart/cart.js
var app = getApp()
Page({
    /**
     * 页面的初始数据
     */
    data: {
        defaultAddress: '',
        addresslist: [],
        cartList: [],
        nodata: true,
        showAddressModel: false,
        showPartsModel: false,
        parts: [],
        totalPrice: 0,
        totlaCount: 0,
        allCheck: 0, //0全选  1非全选
        shopId: [], // 全选 单选时
        shopingId:'',
        productDetail: [],
        typeId: '', //配件id
        partsId: '', //配件id
        imgBaseUrl: app.globalData.imgUrl,
			
    },

    getDafaultAddress: function () {
        var _this = this
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/address/defaultAddress?userId=${app.globalData.userId}`,
            method: 'GET',
            header: {
                "content-type": "application/json", // 默认值
                token: app.globalData.token,
            },
            success: function (res) {
                if (res.data.status == "0000") {
                    _this.setData({
                        defaultAddress: res.data.result
                    })
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },

    getAddressList: function () {
        var _this = this
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/address/myAddressList?pageNo=1&pageSize=30&userId=${app.globalData.userId}`,
            method: "get",
            header: {
                "content-type": "application/json", // 默认值
                "token": app.globalData.token
            },
            data: {},
            success: function (res) {
                wx.hideLoading();
                if (res.data.status === "0000") {
                    _this.setData({
                        addresslist: res.data.result.list
                    })
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },
    getCartList: function () {
        var _this = this
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/shopping/myShopping?userId=${app.globalData.userId}`,
            method: "get",
            header: {
                "content-type": "application/json", // 默认值
                "token": app.globalData.token
            },
            data: {},
            success: function (res) {
                wx.hideLoading();
                if (res.data.status === "0000") {
                    if (res.data.result.length == 0) {
                        _this.setData({
                            nodata: true
                        })
                    } else {
                        _this.setData({
                            nodata: false,
                            cartList: res.data.result
                        })
                        var shopId = []
                        var totalPrice = 0
                        var allCheck = 0
                        var totlaCount = 0
                        for (var value of _this.data.cartList) {
                            shopId.push(value.shopingId)
                            totalPrice += value.check ? (parseInt(value.unitPrice) / 100) * value.number : 0
                            allCheck += value.check
                            totlaCount += value.check ? value.number: 0
                        }
                        _this.setData({
                            totalPrice: totalPrice,
                            shopId: shopId,
                            allCheck: 0 <= allCheck && allCheck < res.data.result.length ? 0 : 1,
                            totlaCount: totlaCount
                        })
                    }

                } else {
                    _this.setData({
                        nodata: true
                    })
                }
                wx.stopPullDownRefresh()
            }
        })
    },

    delShoppingRequest: function (shopingId) {
        var _this = this
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/shopping/delShoppingCart`,
            method: 'post',
            header: {
                "content-type": "application/json", // 默认值
                token: app.globalData.token,
            },
            data: {
                shopingId: shopingId
            },
            success: function (res) {
                if (res.data.status == "0000") {
                    wx.hideLoading({})
                    wx.showToast({
                        title: '已成功删除商品',
                        icon: 'none'
                    })
                    _this.getCartList()
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },

    delShoppingCart: function (e) {
        var shopingId = e.currentTarget.dataset.shopingid
        var _this = this
        wx.showModal({
            title: '提示',
            content: '是否删除此商品',
            success(res) {
                if (res.confirm) {
                    wx.showLoading({
                        title: '加载中...'
                    })
                    _this.delShoppingRequest(shopingId)
                } else if (res.cancel) {
                    // console.log('用户点击取消')
                }
            }
        })
    },

    onIncreaseTap: function (e) {
        var shopingId = e.currentTarget.dataset.shopingid
        this.productCountChange(shopingId, 1)
    },

    onReduceTap: function (e) {
        var shopingId = e.currentTarget.dataset.shopingid
        this.productCountChange(shopingId, 2)
    },

    productCountChange: function (shopingId, action) {
        var _this = this
        wx.showLoading({
            title: '正在重新计算价格...',
            mask: true
        })
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/shopping/singleProductIncrease`,
            method: 'post',
            header: {
                "content-type": "application/json", // 默认值
                token: app.globalData.token,
            },
            data: {
                shopingId: shopingId,
                action: action
            },
            success: function (res) {
                if (res.data.status == "0000") {
                    setTimeout(function () {
                        wx.hideLoading({})
                    }, 300)
                    _this.getCartList()
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },

    onAddressTap: function () {
        this.setData({
            showAddressModel: true
        })
    },

    closedModel: function () {
        this.setData({
            showAddressModel: false
        })
    },

    detailAddress: function (e) {
        this.setData({
            defaultAddress: e.detail.address,
            showAddressModel: false
        })
    },

    onPartTap: function (e) {
        var typeId = e.currentTarget.dataset.parts.typeId
        var partsId = e.currentTarget.dataset.parts.partsId
        this.setData({
            showPartsModel: true,
            shopingId: e.currentTarget.dataset.shopingid,
            typeId: typeId,
            partsId: partsId
        })
        this.getProductDetail(typeId, partsId)
    },

    closedPartsModel: function () {
        this.setData({
            showPartsModel: false,
            parts: []
        })
    },

    onRadioTap: function (e) {
        var status = e.currentTarget.dataset.check ? '1' : '3'
        var shopingId = e.currentTarget.dataset.shopingid
        var _this = this
        wx.showLoading({
            title: '正在重新计算价格...',
            mask: true
        })
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/shopping/shoppingCartCheck`,
            method: 'post',
            header: {
                "content-type": "application/json", // 默认值
                token: app.globalData.token,
            },
            data: {
                shopId: [...shopingId],
                status: status
            },
            success: function (res) {
                if (res.data.status == "0000") {
                    setTimeout(function () {
                        wx.hideLoading({})
                    }, 300)
                    _this.getCartList()
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },

    getProductDetail: function (typeId, partsId, entrance = '1') {//entrance 1:购物车 2:产品列表
        var _this = this
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/equipment/deviceInformation?typeId=${typeId}&partsId=${partsId}&entrance=${entrance}`,
            method: 'GET',
            header: {
                "content-type": "application/json", // 默认值
                token: app.globalData.token,
            },
            success: function (res) {
                if (res.data.status == "0000") {
                    _this.setData({
                        productDetail: res.data.result,
                    },function(){
                        _this.getPriceAndArea()
                    })
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },

    onModelTap: function (e) {
        var stockStatus = e.currentTarget.dataset.stock
        var typeId = e.currentTarget.dataset.typeid
        if (!stockStatus) {
            wx.showToast({
                title: '无库存',
                icon: 'none'
            })
            return
        }
        this.setProductDetail(typeId)
    },

  
    onPowerTap: function (e) {
        var stockStatus = e.currentTarget.dataset.stock
        var partsId = e.currentTarget.dataset.partsid
        var level = e.currentTarget.dataset.level
        var typeId = this.data.typeId
        if (!stockStatus) {
            wx.showToast({
                title: '无库存',
                icon: 'none'
            })
            return
        }
        this.setData({
            price: e.currentTarget.dataset.price,
            heatingArea: e.currentTarget.dataset.heatingarea,
            partsId: partsId
        })
        this.setProductDetail(typeId, partsId, level)
    },

    setProductDetail: function (typeId, partsId, level) {
        var productDetail = this.data.productDetail
        for (var idx in productDetail) {
            productDetail[idx].check = false
            if (productDetail[idx].typeId == typeId) {
                productDetail[idx].check = true
            }
            if (partsId) {
                var seconddata = productDetail[idx].parts.parts
                for (var idx_part in seconddata) {
                    if (level == 'second') {
                        if (seconddata[idx_part].partsId == partsId) {
                            seconddata[idx_part].check = true
                        } else {
                            seconddata[idx_part].check = false
                        }
                    }
                    var thirddata = seconddata[idx_part].parts ? seconddata[idx_part].parts.parts : null
                    if (thirddata && level == 'third') {
                        console.log(thirddata)
                        for (var idx_part_z in thirddata) {
                            if (thirddata[idx_part_z].partsId == partsId) {
                                thirddata[idx_part_z].check = true
                            } else {
                                thirddata[idx_part_z].check = false
                            }
                        }
                    }
                }
            }
        }
        this.setData({
            productDetail: productDetail,
            typeId: typeId,
            partsId: partsId
        })
        this.getPriceAndArea()
    },

    getPriceAndArea() {
        var productDetail = this.data.productDetail
        for (var idx in productDetail) {
            var seconddata = productDetail[idx].parts.parts
            for (var idx_part in seconddata) {

                if (seconddata[idx_part].check) {
                    this.setData({
                        partsId: seconddata[idx_part].partsId,
                        price:  seconddata[idx_part].money / 100,
                        heatingArea: seconddata[idx_part].heatingArea,
                    })
                }

                var thirddata = seconddata[idx_part].parts ? seconddata[idx_part].parts.parts : null
                for (var idx_part_z in thirddata) {
                    if (thirddata[idx_part_z].check) {
                        this.setData({
                            partsId: thirddata[idx_part_z].partsId,
                            price:  thirddata[idx_part_z].money,
                            heatingArea: thirddata[idx_part_z].heatingArea,
                        })
                    }

                }
            }
        }

    },

    onSureTap: function(){
        if(!this.data.typeId || !this.data.partsId){
            wx.showToast({
              title: '请选择型号',
              icon: 'none',
            })
            return
        }
        wx.showLoading({
          title: '加载中...',
          mask: true
        })
        var _this = this
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/shopping/addShoppingCart`,
            method: 'post',
            header: {
                "content-type": "application/json", // 默认值
                token: app.globalData.token,
            },
            data:{
                userId: app.globalData.userId,
                shopId: _this.data.shopingId,
                typeId: _this.data.typeId,
                partsId: _this.data.partsId,
            },
            success: function (res) {
                if (res.data.status == "0000") {
                    _this.getCartList()
                    _this.setData({
                        showPartsModel: false
                    })
                    wx.hideLoading()
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },

    onCartTap: function(e){
        wx.navigateTo({
          url: '/pages/productdetail/productdetail?id='+ e.currentTarget.dataset.typeid,
        })
    },

    onBuyTap: function(){
        if(!this.data.defaultAddress){
            wx.showToast({
              title: '请选择地址',
              icon: 'none',
            })
            return
        }
        var _this = this
        var partsIdArr = []
        for(var value of this.data.cartList){
            value.check && partsIdArr.push(value.shopingId)
        }
        wx.request({
            url: app.globalData.baseUrl + `/ty/heatingApplet/order/createPayInfo`,
            method: 'post',
            header: {
                "content-type": "application/json", // 默认值
                token: app.globalData.token,
            },
            data:{
                userId: app.globalData.userId,
                orderType: '2',
                partsIdArr: partsIdArr,
                addressId: _this.data.defaultAddress.id,
            },
            success: function (res) {
                if (res.data.status == "0000") {
                    var payargs = res.data.result
                   wx.requestPayment({
                    timeStamp: payargs.timeStamp,
                    nonceStr: payargs.nonceStr,
                    package: payargs.package,
                    signType: payargs.signType,
                    paySign: payargs.paySign,
                    success(res){
                        wx.navigateTo({
                          url: '/pages/order/order?orderId=' + payargs.orderId,
                        })
                    }
                  })
                } else {
                    wx.showToast({
                        title: res.data.message,
                        icon: 'none'
                    })
                }
            }
        })
    },

    addAdress(){
        wx.navigateTo({
          url: '/pages/addressedit/addressedit?type=add',
        })
    },

    /**
     * 生命周期函数--监听页面加载
     */
    onLoad: function (options) {},

    /**
     * 生命周期函数--监听页面初次渲染完成
     */
    onReady: function () {

    },

    /**
     * 生命周期函数--监听页面显示
     */
    onShow: function () {
        wx.showLoading({
            title: '加载中...'
        });
        this.getDafaultAddress()
        this.getAddressList()
        this.getCartList()
    },

    /**
     * 生命周期函数--监听页面隐藏
     */
    onHide: function () {

    },

    /**
     * 生命周期函数--监听页面卸载
     */
    onUnload: function () {

    },

    /**
     * 页面相关事件处理函数--监听用户下拉动作
     */
    onPullDownRefresh: function () {
        wx.showLoading({
            title: '页面重新加载中...'
        });
        this.getDafaultAddress()
        this.getAddressList()
        this.getCartList()
    },

    /**
     * 页面上拉触底事件的处理函数
     */
    onReachBottom: function () {

    },

    /**
     * 用户点击右上角分享
     */
    onShareAppMessage: function () {

    }
})