<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<title>任务详情</title>
		<script src="bdist/js/jquery.min.js"></script>
		<script src="bdist/js/bootstrap.min.js"></script>
		<script src="bdist/js/jquerysession.js"></script>
		<script src="bdist/js/sess.js"></script>
		<script src="bdist/js/app.js"></script>
		<link rel="stylesheet" href="bdist/css/bootstrap.min.css" >		
		<link rel="stylesheet" href="bdist/css/pub.css">
	</head>
	<style>		
		p{padding: 3px;}		
		.bd-callout {		 
		    border: 1px #fff dashed;
		    border-left-width: .13rem;		   
		}
		.bd-callout-warning {
		    border-left-color: #f0ad4e;
		}		
		
	</style>
	
	<body>
	 	
	   <div class="bg-f p-3">
		    
		    <p class="font-weight-bold title"></p>		
		    <p style="color: #FFCB4F;">任务时间 <span class="timeTote"></span></p>
			<p class="mt-3 font-weight-bold">任务金额</p>
			<p class="moneyReward" style="color: #F66A52;"><label></label><label>元</label></p>
			<p class="mt-1 font-weight-bold ">任务说明</p>
			<p class="mb-3 detailed" style="color: #666666;"></p>
	   </div>
	   <div class="bg-f mt-2 p-3">
		   <div class="bd-callout bd-callout-warning p-2 list"></div>
		   <div>
			        <img  width="100" id="shangchuanimg" />	 
			        <div class="upload-wrap anticon ml-2" nv-file-drop="" uploader="uploader">
					<input id="input-file" class="file-ele" type="file" file-model="image" name="image" accept="image/*" nv-file-select uploader="uploader" multiple /><div class="file-open">
					<em class="icon icon-upload"></em>&nbsp;上传截图
					</div>
			</div>			   
		   </div>
		   <input type="hidden" id="taskId" value="<%=id%>" />
		   <div class="views_but"></div>
	   </div>
	</body>
</html>
<script>
$("#input-file").on("change",function(){
	var filePath = $(this).val(),         //获取到input的value，里面是文件的路径  
	fileFormat = filePath.substring(filePath.lastIndexOf(".")).toLowerCase(),  
	imgBase64 = '',      //存储图片的imgBase64  
	fileObj = document.getElementById('input-file').files[0]; //上传文件的对象,要这样写才行，用jquery写法获取不到对象  
			              
	// 检查是否是图片  
	if( !fileFormat.match(/.png|.jpg|.jpeg/) ) {  
		alert('上传错误,文件格式必须为：png/jpg/jpeg');  
		return;    
	}  			        
	// 调用函数，对图片进行压缩  
	compress(fileObj,function(imgBase64){  
		imgBase64 = imgBase64;//存储转换后的base64编码  
	    $("#shangchuanimg").attr("src",imgBase64);

	});
});
function compress(fileObj, callback){
	if ( typeof (FileReader) === 'undefined') {    
			console.log("当前浏览器内核不支持base64图标压缩");    
			//调用上传方式不压缩    
			directTurnIntoBase64(fileObj,callback);  
		} else {       
		        var reader = new FileReader();    
			        reader.onload = function (e) { //这是个异步事件               	
					var image = new Image();  
					image.src=e.target.result;
					image.onload = function(){ 
					var originWidth = this.width;
					var originHeight = this.height;	
					 // 最大尺寸限制
					        var maxWidth = 300, maxHeight = 300;
					        // 目标尺寸
					        var targetWidth = originWidth, targetHeight = originHeight;
					        // 图片尺寸超过300x300的限制
					        if (originWidth > maxWidth || originHeight > maxHeight) {
					            if (originWidth / originHeight > maxWidth / maxHeight) {
					                targetWidth = maxWidth;
					                targetHeight = Math.round(maxWidth * (originHeight / originWidth));
					            } else {
					                targetHeight = maxHeight;
					                targetWidth = Math.round(maxHeight * (originWidth / originHeight));
					            }
					        }
					            
					        // canvas对图片进行缩放
					      
			        // square = 100,   //定义画布的大小，也就是图片压缩之后的像素  
			            canvas = document.createElement('canvas'), //创建canvas元素  
			            context = canvas.getContext('2d'),  
			        //  imageWidth = Math.round(square*image.width),    //压缩图片的大小  
			        //  imageHeight = Math.round(square*image.height), 
			        //  data = ''; 		  						
					    canvas.width = targetWidth;
					    canvas.height = targetHeight; 
						 
						context.fillStyle = "#fff";
						context.fillRect(0, 0, targetWidth, targetHeight);
						
					   // context.clearRect(0, 0, targetWidth, targetHeight);  // 
					    context.drawImage(this, 0, 0, targetWidth, targetHeight);    
						var data = canvas.toDataURL('image/jpeg');    
						// //压缩完成执行回调   
						upimg(data)
						callback(data);    
		            };      
	        };    
		    reader.readAsDataURL(fileObj);    
				            
		}  

}
function directTurnIntoBase64(fileObj,callback){  
	var r = new FileReader();  
	// 转成base64  
	r.onload = function(){  
		//变成字符串  
		imgBase64 = r.result;  
		//console.log(imgBase64);  
		callback(imgBase64);  
	}  
	r.readAsDataURL(fileObj);    //转成Base64格式  
}  		
///////////////////////////////////////////////////////////////////////////////////////////
		
		var parpam ={};
		parpam.userId = $.session.get('uid');
		parpam.taskId =$("#taskId").val();			
		$.ajax({
				type: 'Get',
				url: url+"/ty/incrementHf/task/taskDetails",	
				data: parpam,	
				headers: {
				  token: $.session.get('token')
				},		
				success: function(data){
					
					$.each(data.result.list, function (i,val) {
						if(val.exampleDiagram!="示例图位置,需要配置")
						   var pics='<p class="mb-4"><img src='+val.exampleDiagram+' width=100%></p>'
						else
						    pics=""
						
						$(".list").append('<div class="font-weight-bold pt-1 pb-1" ><span style="min-width:40px;border-radius:50px 0px 50px 50px;background-color:#212121;padding:10px;line-height:30px;color:#fff">'+val.stepNumber+'</span></div><div class="mb-2 mt-2">'+val.detailed+'</div>'+pics)
					});	
					//$(".list").append('<div class="rounded pt-5 pb-5 " style="background-color: #F6F7F8;text-align: center;width: 40%;"><p align="center"><img src="bdist/img/tpan.png"/></p><label  >上传截图</label></div>')
					$(".title").html(data.result.title)
					$(".moneyReward").html(data.result.moneyReward)	
					$(".detailed").html(data.result.detailed)	
					$(".timeTote").html(data.result.timeTote)									
					$("#idtxt").val(data.result.taskId)
					
					if(data.result.status==1)
					$(".views_but").html('<button type="button" onclick="btnup()"  class=" btn btn-warning w-100 mt-4 disabled">领取任务</button>')
					else if(data.result.status==2)
					$(".views_but").html('<button type="button"  class="btn btn-warning w-100 mt-4 disabled">已领取未提交</button>')
					else if(data.result.status==3)
					$(".views_but").html('<button type="button"  class="btn btn-warning w-100 mt-4 disabled">待审核</button>')
					else if(data.result.status==4)
					$(".views_but").html('<button type="button"  class="btn btn-warning w-100 mt-4 disabled">已完成</button>')
					else if(data.result.status==5)
					$(".views_but").html('<button type="button"  class="btn btn-warning w-100 mt-4 disabled">已超时</button>')
					else if(data.result.status==6)
					$(".views_but").html('<button type="button"  class="btn btn-warning w-100 mt-4 disabled">已放弃</button>')
				}
		});	
		function btnup()
		{
			 var parpams ={};
			 parpams.userId = $.session.get('uid');	
			 // $.ajax({
			 // 		type: 'get',
			 // 		url: "http://101.200.129.62:8082/ty/incrementHf/task/myTaskList",	
			 // 		data: parpams,
			 // 		headers: {
			 // 		  token: $.session.get('token')
			 // 		},								
			 // 		success: function(data){
			 // 			alert(JSON.stringify(data.result));							
			 // 		}
			 // });	
		}
		
		function upimg(imgurl)
		{
			$("img").show();
			 var parpamp ={}
			 parpamp.img=imgurl;//$("#shangchuanimg").attr("src");
			 parpamp.userId = uid;
			 parpamp.receiveId = $("#taskId").val();

			 // $.ajax({
			 // 		type: 'POST',
			 // 		url: url+"/ty/incrementHf/task/insertUserStep",
			 // 		data: JSON.stringify(parpamp),
			 // 		contentType: "application/json",					
			 // 		headers: {
			 // 		    token: token
			 // 		},	
			 // 		success: function(data){							
			 // 				alert(data.message);							
			 // 		}
			 // });		
		}
		$(document).ready(function(){	
			$(".btn-img").click(function(){});	
			$("img").hide();
		});
	</script>